<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Економетричний Дашборд - Торгівельно-виробниче підприємство</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar-brand {
            font-weight: bold;
            color: #2c3e50 !important;
        }
        
        .kpi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .kpi-card:hover {
            transform: translateY(-5px);
        }
        
        .kpi-card.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .kpi-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .kpi-card.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .kpi-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .kpi-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chart-container-with-margins {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 0 30px 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            color: #2c3e50;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .filter-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .btn-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            color: white;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <!-- Навігаційна панель -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i>
                Економетричний Дашборд
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link me-3" href="/docs-page">
                    <i class="fas fa-book me-1"></i>
                    Документація
                </a>
                <a class="nav-link me-3" href="/docs" target="_blank">
                    <i class="fas fa-code me-1"></i>
                    API Docs
                </a>
                <button class="btn btn-custom" onclick="regenerateData()">
                    <i class="fas fa-sync-alt me-2"></i>
                    Оновити дані
                </button>
            </div>
        </div>
    </nav>

    <!-- Індикатор статусу даних -->
    <div class="container mt-3">
        <div class="alert alert-info d-flex align-items-center" id="data-status-alert" style="display: none !important;">
            <i class="fas fa-info-circle me-2"></i>
            <div>
                <strong>Статус даних:</strong> <span id="data-status-text">Завантаження...</span>
                <small class="d-block text-muted" id="data-status-details"></small>
            </div>
        </div>
    </div>

 
    <div class="container mt-4">
        <!-- KPI Панель -->
        <div class="row" id="kpi-panel">
            <div class="col-md-3">
                <div class="kpi-card success">
                    <div class="kpi-value" id="total-revenue">₴0</div>
                    <div class="kpi-label">
                        <i class="fas fa-money-bill-wave me-2"></i>
                        Загальна виручка
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card warning">
                    <div class="kpi-value" id="total-profit">₴0</div>
                    <div class="kpi-label">
                        <i class="fas fa-chart-pie me-2"></i>
                        Загальний прибуток
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card info">
                    <div class="kpi-value" id="total-sales">0</div>
                    <div class="kpi-label">
                        <i class="fas fa-shopping-cart me-2"></i>
                        Кількість продажів
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-value" id="profit-margin">0%</div>
                    <div class="kpi-label">
                        <i class="fas fa-percentage me-2"></i>
                        Середня маржа
                    </div>
                </div>
            </div>
        </div>

        <!-- Фільтри -->
        <div class="filter-section">
            <h5 class="mb-3">
                <i class="fas fa-filter me-2"></i>
                Фільтри даних
            </h5>
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Початкова дата</label>
                    <input type="date" class="form-control" id="start-date">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Кінцева дата</label>
                    <input type="date" class="form-control" id="end-date">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Категорія</label>
                    <select class="form-select" id="category-filter">
                        <option value="">Всі категорії</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Регіон</label>
                    <select class="form-select" id="region-filter">
                        <option value="">Всі регіони</option>
                    </select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-12">
                    <button class="btn btn-custom" onclick="applyFilters()">
                        <i class="fas fa-search me-2"></i>
                        Застосувати фільтри
                    </button>
                    <button class="btn btn-outline-secondary ms-2" onclick="clearFilters()">
                        <i class="fas fa-times me-2"></i>
                        Очистити
                    </button>
                </div>
            </div>
        </div>

        <!-- Графіки -->
        <div class="row">
            <!-- Графік продажів у часі -->
            <div class="col-md-6">
                <div class="chart-container">
                    <div class="chart-title">
                        <i class="fas fa-chart-line me-2"></i>
                        Динаміка продажів
                    </div>
                    <div id="sales-chart" style="height: 400px;"></div>
                </div>
            </div>
            
            <!-- Графік продажів за продуктами -->
            <div class="col-md-6">
                <div class="chart-container">
                    <div class="chart-title">
                        <i class="fas fa-chart-bar me-2"></i>
                        Топ продуктів
                    </div>
                    <div id="products-chart" style="height: 400px;"></div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Графік продажів за регіонами -->
            <div class="col-md-6">
                <div class="chart-container">
                    <div class="chart-title">
                        <i class="fas fa-chart-pie me-2"></i>
                        Розподіл за регіонами
                    </div>
                    <div id="regions-chart" style="height: 400px;"></div>
                </div>
            </div>
            
            <!-- Графік рентабельності -->
            <div class="col-md-6">
                <div class="chart-container">
                    <div class="chart-title">
                        <i class="fas fa-chart-area me-2"></i>
                        Рентабельність продуктів
                    </div>
                    <div id="profitability-chart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
        
        <!-- Панель перегляду файлів -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="chart-container">
                    <div class="chart-title">
                        <i class="fas fa-database me-2"></i>
                        Перегляд файлів даних
                        <button class="btn btn-sm btn-outline-success ms-2" onclick="loadFilesList()" title="Оновити список файлів">
                            <i class="fas fa-sync-alt"></i> Оновити
                        </button>
                    </div>
                    <div id="files-panel">
                        <div class="row">
                            <div class="col-md-4">
                                <h6>Файли даних</h6>
                                <div id="files-list" class="list-group">
                                    <!-- Список файлів буде завантажений тут -->
                                </div>
                            </div>
                            <div class="col-md-8">
                                <h6>Вміст файлу</h6>
                                <div id="file-content">
                                    <p class="text-muted">Оберіть файл для перегляду</p>
                                </div>
                                <div id="file-pagination" class="mt-3">
                                    <!-- Пагінація буде тут -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        

        <!-- Панель даних Світового банку (переміщено в кінець сторінки з відступами) -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="chart-container-with-margins">
                    <div class="chart-title">
                        <i class="fas fa-globe me-2"></i>
                        Економетричні дані Світового банку
                        <button class="btn btn-sm btn-outline-success ms-2" onclick="loadWorldBankData()" title="Оновити дані" id="worldbank-refresh-btn">
                            <i class="fas fa-sync-alt"></i> Оновити
                        </button>
                        <button class="btn btn-sm btn-outline-warning ms-2" onclick="clearAllWorldBankData()" title="Очистити всі збережені дані" id="worldbank-clear-btn">
                            <i class="fas fa-trash-alt"></i> Очистити
                        </button>
                        <span id="worldbank-status" class="ms-3 text-muted small"></span>
                    </div>
                    <div id="worldbank-panel">
                        <!-- Загальний статус API Світового банку -->
                        <div class="alert alert-info d-flex align-items-center mb-3" id="worldbank-api-status-alert" aria-live="polite" aria-atomic="true">
                            <i class="fas fa-info-circle me-2"></i>
                            <div>
                                <strong>API Статус:</strong> <span id="worldbank-api-status-text">Перевірка...</span>
                                <small class="d-block text-muted" id="worldbank-api-status-details">Тестуємо підключення до Світового банку</small>
                            </div>
                        </div>
                        

                        <!-- Навігація по розділах -->
                        <ul class="nav nav-tabs" id="worldbank-tabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="indicators-tab" data-bs-toggle="tab" data-bs-target="#indicators-content" type="button" role="tab">
                                    <i class="fas fa-chart-line me-1"></i>
                                    Показники
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="normalized-tab" data-bs-toggle="tab" data-bs-target="#normalized-content" type="button" role="tab">
                                    <i class="fas fa-calculator me-1"></i>
                                    Нормалізовані
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="health-tab" data-bs-toggle="tab" data-bs-target="#health-content" type="button" role="tab">
                                    <i class="fas fa-heartbeat me-1"></i>
                                    Економічне здоров'я
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="comparison-tab" data-bs-toggle="tab" data-bs-target="#comparison-content" type="button" role="tab">
                                    <i class="fas fa-balance-scale me-1"></i>
                                    Порівняння
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="trends-tab" data-bs-toggle="tab" data-bs-target="#trends-content" type="button" role="tab">
                                    <i class="fas fa-trending-up me-1"></i>
                                    Тренди
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="api-monitor-tab" data-bs-toggle="tab" data-bs-target="#api-monitor-content" type="button" role="tab">
                                    <i class="fas fa-terminal me-1"></i>
                                    API Моніторинг
                                </button>
                            </li>
                        </ul>

                        <!-- Вміст вкладок -->
                        <div class="tab-content" id="worldbank-tab-content">
                            <!-- Вкладка показників -->
                            <div class="tab-pane fade show active" id="indicators-content" role="tabpanel">
                                    <!-- Статус для вкладки Показники -->
                                    <div class="alert alert-light d-flex align-items-center mb-3" id="indicators-status-alert" style="display: none;">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <div>
                                            <strong>Підказка:</strong> <span id="indicators-status-text">Натисніть "Завантажити"</span>
                                            <small class="d-block text-muted" id="indicators-status-details">Оберіть країни, показники та період</small>
                                        </div>
                                    </div>
                                    
                                    <!-- Фільтри для показників Світового банку -->
                                    <div class="row mb-3">
                                        <div class="col-md-3">
                                            <label class="form-label">Країни</label>
                                            <select id="worldbank-countries" class="form-select" multiple>
                                                <!-- Буде заповнено динамічно -->
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Показники</label>
                                            <select id="worldbank-indicators" class="form-select" multiple>
                                                <!-- Буде заповнено динамічно -->
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Початковий рік</label>
                                            <input type="number" id="worldbank-start-year" class="form-control" value="2020" min="1960" max="2024">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Кінцевий рік</label>
                                            <input type="number" id="worldbank-end-year" class="form-control" value="2023" min="1960" max="2024">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">&nbsp;</label>
                                            <div>
                                                <button class="btn btn-custom w-100" onclick="loadWorldBankData()">
                                                    <i class="fas fa-download me-1"></i>
                                                    Завантажити
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                <div class="row mt-3">
                                    <div class="col-md-12">
                                        <div id="worldbank-indicators-chart" style="height: 500px;"></div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-12">
                                        <div class="mb-2 text-muted small">
                                            Валюта показників: <span class="badge bg-secondary">USD</span> <span class="ms-1">(за даними Світового банку)</span>
                                        </div>
                                        <div class="table-responsive">
                                            <table id="worldbank-indicators-table" class="table table-striped">
                                                <thead>
                                                    <tr>
                                                        <th>Країна</th>
                                                        <th>Рік</th>
                                                        <th>ВВП (USD)</th>
                                                        <th>ВВП на душу (USD)</th>
                                                        <th>Інфляція</th>
                                                        <th>Безробіття</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- Дані будуть завантажені тут -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Вкладка порівняння -->
                            <div class="tab-pane fade" id="comparison-content" role="tabpanel">
                                    <!-- Статус для вкладки Порівняння -->
                                    <div class="alert alert-light d-flex align-items-center mb-3" id="comparison-status-alert" style="display: none;">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <div>
                                            <strong>Підказка:</strong> <span id="comparison-status-text">Натисніть "Порівняти"</span>
                                            <small class="d-block text-muted" id="comparison-status-details">Оберіть показник, країни та років для аналізу</small>
                                        </div>
                                    </div>
                                    
                                <div class="row mt-3">
                                    <div class="col-md-8">
                                        <div id="worldbank-comparison-chart" style="height: 400px;"></div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">Налаштування порівняння</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Показник</label>
                                                    <select id="comparison-indicator" class="form-select">
                                                        <option value="GDP_PER_CAPITA">ВВП на душу населення</option>
                                                        <option value="GDP" selected>ВВП</option>
                                                        <option value="INFLATION">Інфляція</option>
                                                        <option value="UNEMPLOYMENT">Безробіття</option>
                                                        <option value="LIFE_EXPECTANCY">Тривалість життя</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Країни для порівняння</label>
                                                    <input type="text" id="comparison-countries" class="form-control" placeholder="UA,US,DE,PL" value="UA,US,DE,PL">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Років для аналізу</label>
                                                    <input type="number" id="comparison-years" class="form-control" value="10" min="5" max="30">
                                                </div>
                                                <button class="btn btn-custom w-100" onclick="loadComparisonData()">
                                                    <i class="fas fa-chart-bar me-1"></i>
                                                    Порівняти
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Вкладка трендів -->
                            <div class="tab-pane fade" id="trends-content" role="tabpanel">
                                    <!-- Статус для вкладки Тренди -->
                                    <div class="alert alert-light d-flex align-items-center mb-3" id="trends-status-alert" style="display: none;">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <div>
                                            <strong>Підказка:</strong> <span id="trends-status-text">Натисніть "Аналізувати"</span>
                                            <small class="d-block text-muted" id="trends-status-details">Оберіть країну, показники та років для аналізу</small>
                                        </div>
                                    </div>
                                    
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">Аналіз трендів</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Країна</label>
                                                    <select id="trends-country" class="form-select">
                                                        <option value="UA" selected>Україна</option>
                                                        <option value="US">США</option>
                                                        <option value="DE">Німеччина</option>
                                                        <option value="PL">Польща</option>
                                                        <option value="CN">Китай</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Показники</label>
                                                    <select id="trends-indicators" class="form-select" multiple>
                                                        <option value="GDP" selected>ВВП</option>
                                                        <option value="GDP_PER_CAPITA">ВВП на душу</option>
                                                        <option value="INFLATION">Інфляція</option>
                                                        <option value="UNEMPLOYMENT">Безробіття</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Років для аналізу</label>
                                                    <input type="number" id="trends-years" class="form-control" value="20" min="5" max="50">
                                                </div>
                                                <button class="btn btn-custom w-100" onclick="loadTrendsData()">
                                                    <i class="fas fa-trending-up me-1"></i>
                                                    Аналізувати
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div id="worldbank-trends-chart" style="height: 500px;"></div>
                                        <div id="trends-analysis" class="mt-3">
                                            <!-- Результати аналізу будуть тут -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Вкладка нормалізованих даних -->
                            <div class="tab-pane fade" id="normalized-content" role="tabpanel">
                                    <!-- Статус для вкладки Нормалізовані -->
                                    <div class="alert alert-light d-flex align-items-center mb-3" id="normalized-status-alert" style="display: none;">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <div>
                                            <strong>Підказка:</strong> <span id="normalized-status-text">Натисніть "Нормалізувати дані"</span>
                                            <small class="d-block text-muted" id="normalized-status-details">Оберіть країни, показники, валюту та період</small>
                                        </div>
                                    </div>
                                    
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-calculator me-2"></i>
                                                    Нормалізація даних
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Країни</label>
                                                    <select id="normalized-countries" class="form-select" multiple>
                                                        <option value="UA" selected>Україна</option>
                                                        <option value="US">США</option>
                                                        <option value="DE">Німеччина</option>
                                                        <option value="PL">Польща</option>
                                                        <option value="FR">Франція</option>
                                                        <option value="GB">Великобританія</option>
                                                        <option value="CN">Китай</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Показники</label>
                                                    <select id="normalized-indicators" class="form-select" multiple>
                                                        <option value="GDP" selected>ВВП</option>
                                                        <option value="GDP_PER_CAPITA">ВВП на душу</option>
                                                        <option value="INFLATION">Інфляція</option>
                                                        <option value="UNEMPLOYMENT">Безробіття</option>
                                                        <option value="EXPORTS">Експорт</option>
                                                        <option value="IMPORTS">Імпорт</option>
                                                        <option value="POPULATION">Населення</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Валюта</label>
                                                    <select id="normalized-currency" class="form-select">
                                                        <option value="USD">Долар США</option>
                                                        <option value="EUR">Євро</option>
                                                        <option value="UAH">Гривня</option>
                                                        <option value="PLN">Злотий</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Початковий рік</label>
                                                    <input type="number" id="normalized-start-year" class="form-control" value="2020" min="2000" max="2023">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Кінцевий рік</label>
                                                    <input type="number" id="normalized-end-year" class="form-control" value="2023" min="2000" max="2023">
                                                </div>
                                                <button class="btn btn-custom w-100" onclick="loadNormalizedData()">
                                                    <i class="fas fa-calculator me-1"></i>
                                                    Нормалізувати дані
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div id="normalized-chart" style="height: 500px;"></div>
                                        <div id="normalized-table" class="mt-3">
                                            <!-- Таблиця нормалізованих даних -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Вкладка аналізу економічного здоров'я -->
                            <div class="tab-pane fade" id="health-content" role="tabpanel">
                                    <!-- Статус для вкладки Економічне здоров'я -->
                                    <div class="alert alert-light d-flex align-items-center mb-3" id="health-status-alert" style="display: none;">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <div>
                                            <strong>Підказка:</strong> <span id="health-status-text">Натисніть "Аналізувати здоров'я"</span>
                                            <small class="d-block text-muted" id="health-status-details">Оберіть країни та період для аналізу економічного здоров'я</small>
                                        </div>
                                    </div>
                                    
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-heartbeat me-2"></i>
                                                    Аналіз економічного здоров'я
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Країни для аналізу</label>
                                                    <select id="health-countries" class="form-select" multiple>
                                                        <option value="UA" selected>Україна</option>
                                                        <option value="US">США</option>
                                                        <option value="DE">Німеччина</option>
                                                        <option value="PL">Польща</option>
                                                        <option value="FR">Франція</option>
                                                        <option value="GB">Великобританія</option>
                                                        <option value="CN">Китай</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Початковий рік</label>
                                                    <input type="number" id="health-start-year" class="form-control" value="2020" min="2000" max="2023">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Кінцевий рік</label>
                                                    <input type="number" id="health-end-year" class="form-control" value="2023" min="2000" max="2023">
                                                </div>
                                                <button class="btn btn-custom w-100" onclick="loadEconomicHealth()">
                                                    <i class="fas fa-heartbeat me-1"></i>
                                                    Аналізувати здоров'я
                                                </button>
                                                <div class="mt-3">
                                                    <small class="text-muted">
                                                        <strong>Методологія:</strong><br>
                                                        • ВВП на душу: 30%<br>
                                                        • Інфляція: 25%<br>
                                                        • Безробіття: 25%<br>
                                                        • Тривалість життя: 20%
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div id="health-chart" style="height: 500px;"></div>
                                        <div id="health-analysis" class="mt-3">
                                            <!-- Результати аналізу економічного здоров'я -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Вкладка API Моніторингу -->
                            <div class="tab-pane fade" id="api-monitor-content" role="tabpanel">
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-terminal me-2"></i>
                                                    Моніторинг API запитів до Світового банку
                                                </h6>
                                                <div>
                                                    <button class="btn btn-sm btn-outline-secondary" onclick="clearApiLogs()">
                                                        <i class="fas fa-trash me-1"></i>
                                                        Очистити логи
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-primary" onclick="toggleApiLogs()">
                                                        <i class="fas fa-pause me-1" id="toggle-icon"></i>
                                                        <span id="toggle-text">Пауза</span>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-info" onclick="showServerLogs()">
                                                        <i class="fas fa-server me-1"></i>
                                                        Серверні логи
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-warning" onclick="clearCache()">
                                                        <i class="fas fa-trash-alt me-1"></i>
                                                        Очистити кеш
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <div class="row mb-3">
                                                    <div class="col-md-3">
                                                        <div class="card bg-light">
                                                            <div class="card-body text-center">
                                                                <h5 class="text-primary mb-1" id="api-total-requests">0</h5>
                                                                <small class="text-muted">Всього запитів</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="card bg-light">
                                                            <div class="card-body text-center">
                                                                <h5 class="text-success mb-1" id="api-success-requests">0</h5>
                                                                <small class="text-muted">Успішних</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="card bg-light">
                                                            <div class="card-body text-center">
                                                                <h5 class="text-danger mb-1" id="api-error-requests">0</h5>
                                                                <small class="text-muted">Помилок</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="card bg-light">
                                                            <div class="card-body text-center">
                                                                <h5 class="text-info mb-1" id="api-cached-requests">0</h5>
                                                                <small class="text-muted">З кешу</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="api-logs-container" style="height: 500px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1rem; background-color: #f8f9fa;">
                                                    <div id="api-logs">
                                                        <div class="text-muted text-center">
                                                            <i class="fas fa-info-circle me-2"></i>
                                                            Логи API запитів з'являться тут...
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Панель криптовалют (повна ширина з відступами) -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="chart-container-with-margins">
                <div class="chart-title">
                    <i class="fab fa-bitcoin me-2"></i>
                    Огляд ринку криптовалют
                    <button class="btn btn-sm btn-outline-success ms-2" onclick="loadCryptoMarketData()" title="Оновити дані" id="crypto-refresh-btn">
                        <i class="fas fa-sync-alt"></i> Оновити
                    </button>
                    <button class="btn btn-sm btn-outline-warning ms-2" onclick="clearSavedCryptoData()" title="Очистити збережені дані" id="crypto-clear-btn">
                        <i class="fas fa-trash-alt"></i> Очистити
                    </button>
                    <span id="crypto-status" class="ms-3 text-muted small"></span>
                    <div class="ms-3 d-inline-block">
                        <select id="crypto-currency" class="form-select form-select-sm" style="width: auto; display: inline-block;">
                            <option value="usd" selected>USD</option>
                            <option value="uah">UAH</option>
                            <option value="eur">EUR</option>
                        </select>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-4 mb-2">
                    <div class="small text-muted">
                        <i class="fas fa-globe me-1"></i>
                        Загальна капіталізація ринку: <strong id="crypto-global-mcap">—</strong>
                    </div>
                    <div class="small text-muted">
                        <i class="fab fa-btc me-1"></i>
                        Домінація BTC: <strong id="crypto-global-btc">—</strong>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>Назва</th>
                                <th>Ціна</th>
                                <th>24г (%)</th>
                                <th>Ринкова капіталізація</th>
                                <th>Об'єм (24г)</th>
                            </tr>
                        </thead>
                        <tbody id="crypto-market-table"></tbody>
                    </table>
                </div>
                <div class="mt-2 small text-muted">
                    Джерело даних: <a href="https://www.coingecko.com/en/api/documentation" target="_blank" rel="noopener noreferrer">CoinGecko API</a>. Дані оновлюються з публічного API без ключа.
                </div>
            </div>
        </div>
    </div>

    <!-- Панель Yahoo Finance (під криптовалютами з відступами) -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="chart-container-with-margins">
                <div class="chart-title">
                    <i class="fas fa-chart-line me-2"></i>
                    Фінансові ринки Yahoo Finance
                    <button class="btn btn-sm btn-outline-success ms-2" onclick="loadYahooFinanceData()" title="Оновити дані" id="yahoo-refresh-btn">
                        <i class="fas fa-sync-alt"></i> Оновити
                    </button>
                    <button class="btn btn-sm btn-outline-warning ms-2" onclick="clearYahooFinanceData()" title="Очистити збережені дані" id="yahoo-clear-btn">
                        <i class="fas fa-trash-alt"></i> Очистити
                    </button>
                    <span id="yahoo-status" class="ms-3 text-muted small"></span>
                    <div class="ms-3 d-inline-block">
                        <select id="yahoo-symbol" class="form-select form-select-sm" style="width: auto; display: inline-block;">
                            <option value="AAPL" selected>AAPL (Apple)</option>
                            <option value="MSFT">MSFT (Microsoft)</option>
                            <option value="GOOGL">GOOGL (Google)</option>
                            <option value="AMZN">AMZN (Amazon)</option>
                            <option value="TSLA">TSLA (Tesla)</option>
                            <option value="NVDA">NVDA (NVIDIA)</option>
                            <option value="META">META (Meta)</option>
                            <option value="BTC-USD">BTC-USD (Bitcoin)</option>
                            <option value="ETH-USD">ETH-USD (Ethereum)</option>
                        </select>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-4 mb-2">
                    <div class="small text-muted">
                        <i class="fas fa-dollar-sign me-1"></i>
                        Поточна ціна: <strong id="yahoo-current-price">—</strong>
                    </div>
                    <div class="small text-muted">
                        <i class="fas fa-arrow-up me-1"></i>
                        Зміна: <strong id="yahoo-change">—</strong>
                    </div>
                    <div class="small text-muted">
                        <i class="fas fa-percentage me-1"></i>
                        Зміна %: <strong id="yahoo-change-percent">—</strong>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Показник</th>
                                <th>Значення</th>
                                <th>Зміна</th>
                                <th>Зміна %</th>
                            </tr>
                        </thead>
                        <tbody id="yahoo-finance-table"></tbody>
                    </table>
                </div>
                <div class="mt-2 small text-muted">
                    Джерело даних: <a href="https://finance.yahoo.com/" target="_blank" rel="noopener noreferrer">Yahoo Finance</a>. Дані оновлюються з публічного API.
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Глобальні змінні
        let currentData = {
            sales: [],
            trends: [],
            profit: [],
            stats: {}
        };

        // Тест функціональності
        console.log('✅ JavaScript завантажується правильно');
        
        // Перевірка наявності основних функцій
        window.addEventListener('DOMContentLoaded', function() {
            console.log('✅ DOM завантажений');
            
            // Перевірка наявності кнопок
            const cryptoBtn = document.getElementById('crypto-refresh-btn');
            const worldbankBtn = document.getElementById('worldbank-refresh-btn');
            const filesBtn = document.querySelector('[onclick="loadFilesList()"]');
            
            console.log('🔍 Перевірка кнопок:');
            console.log('  - crypto-refresh-btn:', cryptoBtn ? '✅' : '❌');
            console.log('  - worldbank-refresh-btn:', worldbankBtn ? '✅' : '❌');
            console.log('  - files button:', filesBtn ? '✅' : '❌');
            
            // Перевірка наявності функцій
            console.log('🔍 Перевірка функцій:');
            console.log('  - loadCryptoMarketData:', typeof loadCryptoMarketData === 'function' ? '✅' : '❌');
            console.log('  - loadWorldBankData:', typeof loadWorldBankData === 'function' ? '✅' : '❌');
            console.log('  - loadFilesList:', typeof loadFilesList === 'function' ? '✅' : '❌');
        });

        // Ініціалізація сторінки
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM завантажено');
            loadInitialData();
            setupDateFilters();
            initializeWorldBankData(); // Додаємо ініціалізацію даних Світового банку
            
            // Показуємо підказки для всіх вкладок
            showTabHints();
            
            // Перевіряємо стан API при завантаженні
            checkAPIStatus();
            
            // Завантажуємо файли безпосередньо
            console.log('Запуск завантаження файлів...');
            window.loadFilesList = loadFilesList;
            window.loadFileContent = loadFileContent;
            window.showFileStats = showFileStats;
            window.applyFilters = applyFilters;
            window.clearFilters = clearFilters;
            window.regenerateData = regenerateData;
            
            window.loadWorldBankData = loadWorldBankData;
            window.loadComparisonData = loadComparisonData;
            window.loadTrendsData = loadTrendsData;
            window.loadNormalizedData = loadNormalizedData;
            window.loadEconomicHealth = loadEconomicHealth;
            window.loadCryptoMarketData = loadCryptoMarketData;
            window.loadYahooFinanceData = loadYahooFinanceData;
            window.clearYahooFinanceData = clearYahooFinanceData;

            loadFilesList();

            // Спробувати завантажити збережені крипто дані при завантаженні сторінки
            const savedCryptoData = loadCryptoDataFromStorage();
            if (savedCryptoData) {
                console.log('📂 Показано збережені крипто дані');
                displaySavedCryptoData(savedCryptoData);
            } else {
                console.log('🔄 Збережених даних немає, завантажуємо нові');
                loadCryptoMarketData();
            }

            // Спробувати завантажити збережені Yahoo Finance дані при завантаженні сторінки
            const savedYahooData = loadYahooFinanceDataFromStorage();
            if (savedYahooData) {
                console.log('📂 Показано збережені Yahoo Finance дані');
                displaySavedYahooFinanceData(savedYahooData);
            } else {
                console.log('🔄 Збережених Yahoo Finance даних немає');
            }

            // Спробувати завантажити збережені World Bank дані при завантаженні сторінки
            const worldBankKeys = Object.keys(localStorage).filter(key => key.startsWith('worldBank_'));
            if (worldBankKeys.length > 0) {
                console.log(`📂 Знайдено ${worldBankKeys.length} збережених World Bank даних`);
                updateWorldBankStatus(`Знайдено ${worldBankKeys.length} збережених даних`, 'info');
            } else {
                console.log('🔄 Збережених World Bank даних немає');
            }

            // Авто-перезавантаження ринку при зміні валюти
            const cryptoCur = document.getElementById('crypto-currency');
            if (cryptoCur) {
                cryptoCur.addEventListener('change', () => {
                    loadCryptoMarketData();
                });
            }
        });
        function updateCryptoStatus(message, type = 'info') {
            const statusEl = document.getElementById('crypto-status');
            if (statusEl) {
                const icon = type === 'loading' ? 'fas fa-spinner fa-spin' : 
                           type === 'success' ? 'fas fa-check-circle text-success' :
                           type === 'error' ? 'fas fa-exclamation-triangle text-danger' :
                           'fas fa-info-circle text-info';
                statusEl.innerHTML = `<i class="${icon}"></i> ${message}`;
            }
        }

        function saveCryptoDataToStorage(data, globalData, lastUpdate = null) {
            try {
                const cryptoData = {
                    marketData: data,
                    globalData: globalData,
                    lastUpdate: lastUpdate
                };
                localStorage.setItem('cryptoData', JSON.stringify(cryptoData));
                console.log('💾 Крипто дані збережено локально');
            } catch (error) {
                console.error('❌ Помилка збереження даних:', error);
            }
        }

        function loadCryptoDataFromStorage() {
            try {
                const savedData = localStorage.getItem('cryptoData');
                if (savedData) {
                    const cryptoData = JSON.parse(savedData);
                    console.log('📂 Завантажено збережені крипто дані від:', cryptoData.savedAt);
                    return cryptoData;
                }
            } catch (error) {
                console.error('❌ Помилка завантаження збережених даних:', error);
            }
            return null;
        }

        function displaySavedCryptoData(cryptoData) {
            const { marketData, globalData, lastUpdate } = cryptoData;
            
            // Показати збережені дані ринку
            const tableBody = document.getElementById('crypto-market-table');
            tableBody.innerHTML = '';
            marketData.forEach(coin => {
                const change24h = coin.price_change_percentage_24h;
                const colorClass = (typeof change24h === 'number' && !isNaN(change24h) && change24h >= 0) ? 'text-success' : 'text-danger';
                const symbol = (coin.symbol || '').toUpperCase();
                const currencyCode = 'USD'; // Збережені дані завжди в USD
                const row = `
                    <tr style="cursor:pointer" onclick="openCryptoCoin('${coin.id}', '${coin.name}', '${symbol}', 'usd')">
                        <td>${coin.market_cap_rank ?? ''}</td>
                        <td>
                            <img src="${coin.image}" width="20" height="20" class="me-2">
                            <strong>${coin.name}</strong>
                            <span class="text-muted">${symbol}</span>
                        </td>
                        <td>${formatCurrencyByCode(coin.current_price, currencyCode)}</td>
                        <td class="${colorClass}">${(typeof change24h === 'number' && !isNaN(change24h)) ? change24h.toFixed(2) + '%' : 'N/A'}</td>
                        <td>${formatCurrencyByCode(coin.market_cap || 0, currencyCode)}</td>
                        <td>${formatCurrencyByCode(coin.total_volume || 0, currencyCode)}</td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });

            // Показати збережені глобальні метрики
            if (globalData && globalData.data) {
                const mcapUsd = globalData.data.total_market_cap && globalData.data.total_market_cap.usd ? globalData.data.total_market_cap.usd : null;
                const btcDom = globalData.data.market_cap_percentage && globalData.data.market_cap_percentage.btc ? globalData.data.market_cap_percentage.btc : null;
                
                if (mcapUsd != null) {
                    document.getElementById('crypto-global-mcap').textContent = formatCurrencyByCode(mcapUsd, 'USD');
                }
                if (btcDom != null) {
                    document.getElementById('crypto-global-btc').textContent = btcDom.toFixed(2) + '%';
                }
            }

            // Показати статус збережених даних з часом отримання
            const statusMessage = lastUpdate ? 
                `Показано збережені дані (отримано: ${lastUpdate})` : 
                `Показано збережені дані`;
            updateCryptoStatus(statusMessage, 'info');
            
            const globalStatusEl = document.getElementById('crypto-global-status');
            if (globalStatusEl) {
                const globalStatusMessage = lastUpdate ? 
                    `<i class="fas fa-save text-info"></i> Дані отримано: ${lastUpdate}` : 
                    `<i class="fas fa-save text-info"></i> Збережені дані`;
                globalStatusEl.innerHTML = globalStatusMessage;
            }
        }

        // Обробка клавіші Escape для закриття модальних вікон
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeAllModals();
            }
        });

        // Функція для примусового закриття всіх модальних вікон
        function closeAllModals() {
            try {
                // Закриваємо всі Bootstrap модальні вікна
                const modals = document.querySelectorAll('.modal.show');
                modals.forEach(modal => {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    if (bsModal) {
                        bsModal.hide();
                    }
                });
                
                // Очищаємо всі графіки Plotly
                const chartElements = document.querySelectorAll('[id*="chart"]');
                chartElements.forEach(chartEl => {
                    if (chartEl && typeof Plotly !== 'undefined') {
                        Plotly.purge(chartEl);
                    }
                });
                
                console.log('✅ Всі модальні вікна закрито');
            } catch (error) {
                console.error('❌ Помилка при закритті модальних вікон:', error);
            }
        }

        function clearSavedCryptoData() {
            try {
                localStorage.removeItem('cryptoData');
                console.log('🗑️ Збережені крипто дані очищено');
                
                // Очистити таблицю та метрики
                const tableBody = document.getElementById('crypto-market-table');
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted">
                                <i class="fas fa-info-circle me-2"></i>
                                Дані очищено. Натисніть "Оновити" для завантаження нових даних.
                            </td>
                        </tr>
                    `;
                }
                
                // Очистити глобальні метрики
                document.getElementById('crypto-global-mcap').textContent = '—';
                document.getElementById('crypto-global-btc').textContent = '—';
                
                // Оновити статуси
                updateCryptoStatus('Збережені дані очищено', 'info');
                const globalStatusEl = document.getElementById('crypto-global-status');
                if (globalStatusEl) {
                    globalStatusEl.innerHTML = '<i class="fas fa-trash text-warning"></i> Дані очищено';
                }
                
                // Статуси залишаються видимими
                
            } catch (error) {
                console.error('❌ Помилка очищення даних:', error);
                updateCryptoStatus('Помилка очищення даних', 'error');
            }
        }

        // ==================== YAHOO FINANCE FUNCTIONS ====================
        
        // Завантаження даних з Yahoo Finance
        async function loadYahooFinanceData() {
            try {
                const symbol = document.getElementById('yahoo-symbol').value;
                updateYahooStatus('Завантаження даних...', 'loading');
                
                console.log(`📈 Завантаження даних Yahoo Finance для ${symbol}`);
                
                // Використовуємо наш проксі ендпоінт замість прямого запиту
                const response = await fetch(`/api/yahoo-finance/${symbol}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Оновлюємо інтерфейс
                updateYahooFinanceDisplay(data);
                
                // Зберігаємо дані в localStorage
                const yahooData = {
                    symbol: symbol,
                    data: data,
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('yahooFinanceData', JSON.stringify(yahooData));
                
                updateYahooStatus('Дані успішно завантажено', 'success');
                console.log(`✅ Yahoo Finance дані завантажено для ${symbol}`);
                
            } catch (error) {
                console.error('❌ Помилка завантаження Yahoo Finance даних:', error);
                updateYahooStatus(`Помилка: ${error.message}`, 'error');
                
                // Спробувати показати збережені дані
                const savedData = loadYahooFinanceDataFromStorage();
                if (savedData) {
                    console.log('📂 Показуємо збережені Yahoo Finance дані');
                    displaySavedYahooFinanceData(savedData);
                } else {
                    showYahooFinanceError('Не вдалося завантажити дані');
                }
            }
        }
        
        // Оновлення відображення даних Yahoo Finance
        function updateYahooFinanceDisplay(data) {
            // Оновлюємо основні метрики
            document.getElementById('yahoo-current-price').textContent = formatCurrency(data.currentPrice);
            document.getElementById('yahoo-change').textContent = formatCurrency(data.change);
            document.getElementById('yahoo-change-percent').textContent = formatPercentage(data.changePercent);
            
            // Оновлюємо таблицю
            const tableBody = document.getElementById('yahoo-finance-table');
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td><i class="fas fa-dollar-sign me-2"></i>Попередня закрита ціна</td>
                        <td>${formatCurrency(data.previousClose)}</td>
                        <td>—</td>
                        <td>—</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-door-open me-2"></i>Ціна відкриття</td>
                        <td>${formatCurrency(data.open)}</td>
                        <td>${formatCurrency(data.open - data.previousClose)}</td>
                        <td>${formatPercentage(((data.open - data.previousClose) / data.previousClose) * 100)}</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-arrow-up me-2"></i>Максимальна ціна</td>
                        <td>${formatCurrency(data.high)}</td>
                        <td>${formatCurrency(data.high - data.previousClose)}</td>
                        <td>${formatPercentage(((data.high - data.previousClose) / data.previousClose) * 100)}</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-arrow-down me-2"></i>Мінімальна ціна</td>
                        <td>${formatCurrency(data.low)}</td>
                        <td>${formatCurrency(data.low - data.previousClose)}</td>
                        <td>${formatPercentage(((data.low - data.previousClose) / data.previousClose) * 100)}</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-chart-bar me-2"></i>Об'єм торгів</td>
                        <td>${formatNumber(data.volume)}</td>
                        <td>—</td>
                        <td>—</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-building me-2"></i>Ринкова капіталізація</td>
                        <td>${formatCurrency(data.marketCap)}</td>
                        <td>—</td>
                        <td>—</td>
                    </tr>
                    <tr>
                        <td><i class="fas fa-exchange-alt me-2"></i>Біржа</td>
                        <td>${data.exchange || '—'}</td>
                        <td>—</td>
                        <td>—</td>
                    </tr>
                `;
            }
        }
        
        // Показ помилки Yahoo Finance
        function showYahooFinanceError(message) {
            const tableBody = document.getElementById('yahoo-finance-table');
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${message}
                        </td>
                    </tr>
                `;
            }
            
            // Очистити метрики
            document.getElementById('yahoo-current-price').textContent = '—';
            document.getElementById('yahoo-change').textContent = '—';
            document.getElementById('yahoo-change-percent').textContent = '—';
        }
        
        // Оновлення статусу Yahoo Finance
        function updateYahooStatus(message, type) {
            const statusEl = document.getElementById('yahoo-status');
            if (statusEl) {
                let icon = '';
                let className = '';
                
                switch (type) {
                    case 'loading':
                        icon = 'fas fa-spinner fa-spin';
                        className = 'text-primary';
                        break;
                    case 'success':
                        icon = 'fas fa-check-circle';
                        className = 'text-success';
                        break;
                    case 'error':
                        icon = 'fas fa-exclamation-circle';
                        className = 'text-danger';
                        break;
                    case 'info':
                        icon = 'fas fa-info-circle';
                        className = 'text-info';
                        break;
                    default:
                        icon = 'fas fa-info-circle';
                        className = 'text-muted';
                }
                
                statusEl.innerHTML = `<i class="${icon} ${className}"></i> ${message}`;
            }
        }
        
        // Завантаження збережених даних Yahoo Finance
        function loadYahooFinanceDataFromStorage() {
            try {
                const savedData = localStorage.getItem('yahooFinanceData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    const now = new Date();
                    const savedTime = new Date(data.timestamp);
                    const hoursDiff = (now - savedTime) / (1000 * 60 * 60);
                    
                    // Дані валідні протягом 1 години
                    if (hoursDiff < 1) {
                        return data;
                    } else {
                        console.log('📅 Збережені Yahoo Finance дані застарілі');
                        localStorage.removeItem('yahooFinanceData');
                    }
                }
            } catch (error) {
                console.error('❌ Помилка завантаження збережених Yahoo Finance даних:', error);
            }
            return null;
        }
        
        // Відображення збережених даних Yahoo Finance
        function displaySavedYahooFinanceData(savedData) {
            updateYahooFinanceDisplay(savedData.data);
            updateYahooStatus('Показано збережені дані', 'info');
        }
        
        // Очищення збережених даних Yahoo Finance
        function clearYahooFinanceData() {
            try {
                localStorage.removeItem('yahooFinanceData');
                console.log('🗑️ Збережені Yahoo Finance дані очищено');
                
                // Очистити таблицю та метрики
                showYahooFinanceError('Дані очищено. Натисніть "Оновити" для завантаження нових даних.');
                
                // Оновити статус
                updateYahooStatus('Збережені дані очищено', 'info');
                
            } catch (error) {
                console.error('❌ Помилка очищення Yahoo Finance даних:', error);
                updateYahooStatus('Помилка очищення даних', 'error');
            }
        }

        // World Bank data caching functions
        function saveWorldBankDataToStorage(dataType, data) {
            try {
                const worldBankData = {
                    [dataType]: data,
                    timestamp: new Date().toISOString(),
                    lastUpdate: data.last_update || null
                };
                localStorage.setItem(`worldBank_${dataType}`, JSON.stringify(worldBankData));
                console.log(`💾 World Bank ${dataType} дані збережено локально`);
            } catch (error) {
                console.error('❌ Помилка збереження World Bank даних:', error);
            }
        }

        function loadWorldBankDataFromStorage(dataType) {
            try {
                const savedData = localStorage.getItem(`worldBank_${dataType}`);
                if (savedData) {
                    const worldBankData = JSON.parse(savedData);
                    const lastUpdate = worldBankData.lastUpdate;
                    console.log(`📂 Завантажено збережені World Bank ${dataType} дані`, lastUpdate ? `(отримано: ${lastUpdate})` : '');
                    return worldBankData;
                }
            } catch (error) {
                console.error('❌ Помилка завантаження збережених World Bank даних:', error);
            }
            return null;
        }

        function clearSavedWorldBankData(dataType) {
            try {
                localStorage.removeItem(`worldBank_${dataType}`);
                console.log(`🗑️ Збережені World Bank ${dataType} дані очищено`);
            } catch (error) {
                console.error('❌ Помилка очищення World Bank даних:', error);
            }
        }

        function updateWorldBankStatus(message, type = 'info', elementId = 'worldbank-status') {
            const statusEl = document.getElementById(elementId);
            if (statusEl) {
                const icon = type === 'loading' ? 'fas fa-spinner fa-spin' : 
                           type === 'success' ? 'fas fa-check-circle text-success' :
                           type === 'error' ? 'fas fa-exclamation-triangle text-danger' :
                           'fas fa-info-circle text-info';
                statusEl.innerHTML = `<i class="${icon}"></i> ${message}`;
            }
        }

        function clearAllWorldBankData() {
            try {
                // Очистити всі збережені World Bank дані
                const keys = Object.keys(localStorage);
                let clearedCount = 0;
                
                keys.forEach(key => {
                    if (key.startsWith('worldBank_')) {
                        localStorage.removeItem(key);
                        clearedCount++;
                    }
                });
                
                console.log(`🗑️ Очищено ${clearedCount} збережених World Bank даних`);
                
                // Очистити відображення
                const chartContainer = document.getElementById('worldbank-indicators-chart');
                if (chartContainer) {
                    chartContainer.innerHTML = '<p class="text-muted">Дані очищено. Натисніть "Оновити" для завантаження нових даних.</p>';
                }
                
                const tableContainer = document.getElementById('worldbank-indicators-table');
                if (tableContainer) {
                    tableContainer.innerHTML = '<p class="text-muted">Дані очищено. Натисніть "Оновити" для завантаження нових даних.</p>';
                }
                
                // Оновити статус
                updateWorldBankStatus(`Очищено ${clearedCount} збережених даних`, 'info');
                
                // Очистити статус через 3 секунди
                setTimeout(() => {
                    updateWorldBankStatus('', 'info');
                }, 3000);
                
            } catch (error) {
                console.error('❌ Помилка очищення World Bank даних:', error);
                updateWorldBankStatus('Помилка очищення даних', 'error');
            }
        }

        async function loadCryptoMarketData() {
            try {
                const curSel = document.getElementById('crypto-currency');
                const cur = curSel ? curSel.value : 'usd';
                const apiUrl = `/api/crypto/markets?currency=${encodeURIComponent(cur)}&per_page=100`;
                
                // Оновити статус на панелі
                updateCryptoStatus('Завантаження даних...', 'loading');
                
                console.log('🔄 Запит до крипто API:', apiUrl);
                console.log('📡 Повний URL:', window.location.origin + apiUrl);
                
                const resp = await fetch(apiUrl);
                
                console.log('📊 Статус відповіді:', resp.status, resp.statusText);
                
                if (!resp.ok) {
                    throw new Error(`HTTP error! status: ${resp.status}`);
                }
                
                const response = await resp.json();
                
                // Handle new response format with metadata / Обробка нового формату відповіді з метаданими
                let data, lastUpdate, currency, totalCoins;
                if (response.data && Array.isArray(response.data)) {
                    // New format with metadata / Новий формат з метаданими
                    data = response.data;
                    lastUpdate = response.last_update;
                    currency = response.currency;
                    totalCoins = response.total_coins;
                } else if (Array.isArray(response)) {
                    // Old format (backward compatibility) / Старий формат (зворотна сумісність)
                    data = response;
                    lastUpdate = null;
                    currency = cur;
                    totalCoins = data.length;
                } else {
                    throw new Error('Invalid response format');
                }
                
                console.log('📈 Отримано даних:', totalCoins, 'монет');
                console.log('📋 Валюта:', currency);
                console.log('🕒 Останнє оновлення:', lastUpdate || 'не відомо');
                if (data.length > 0) {
                    console.log('🪙 Перша монета:', data[0].name, '(' + data[0].symbol + ')');
                }
                
                // Оновити статус успіху з часом отримання
                const statusMessage = lastUpdate ? 
                    `Завантажено ${data.length} монет (отримано: ${lastUpdate})` : 
                    `Завантажено ${data.length} монет`;
                updateCryptoStatus(statusMessage, 'success');
                
                const tableBody = document.getElementById('crypto-market-table');
                tableBody.innerHTML = '';
                data.forEach(coin => {
                    const change24h = coin.price_change_percentage_24h;
                    const colorClass = (typeof change24h === 'number' && !isNaN(change24h) && change24h >= 0) ? 'text-success' : 'text-danger';
                    const symbol = (coin.symbol || '').toUpperCase();
                    const currencyCode = (cur || 'usd').toUpperCase();
                    const row = `
                        <tr style="cursor:pointer" onclick="openCryptoCoin('${coin.id}', '${coin.name}', '${symbol}', '${cur}')">
                            <td>${coin.market_cap_rank ?? ''}</td>
                            <td>
                                <img src="${coin.image}" width="20" height="20" class="me-2">
                                <strong>${coin.name}</strong>
                                <span class="text-muted">${symbol}</span>
                            </td>
                            <td>${formatCurrencyByCode(coin.current_price, currencyCode)}</td>
                            <td class="${colorClass}">${(typeof change24h === 'number' && !isNaN(change24h)) ? change24h.toFixed(2) + '%' : 'N/A'}</td>
                            <td>${formatCurrencyByCode(coin.market_cap || 0, currencyCode)}</td>
                            <td>${formatCurrencyByCode(coin.total_volume || 0, currencyCode)}</td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
                
                // Оновити глобальні метрики (в USD)
                const globalData = await loadCryptoGlobal();
                
                // Зберегти дані локально з часом оновлення (тільки якщо глобальні дані отримано)
                if (globalData) {
                    saveCryptoDataToStorage(data, globalData, lastUpdate);
                } else {
                    // Зберегти тільки ринкові дані якщо глобальні недоступні
                    saveCryptoDataToStorage(data, null, lastUpdate);
                }
            } catch (error) {
                console.error('Помилка завантаження крипто-даних:', error);
                
                // Визначити тип помилки та показати відповідне повідомлення
                let errorMessage = error.message;
                let userMessage = 'Не вдалося завантажити дані ринку криптовалют';
                
                if (error.message.includes('Rate limit exceeded')) {
                    userMessage = 'Перевищено ліміт запитів до CoinGecko API. Спробуйте пізніше.';
                } else if (error.message.includes('timeout') || error.message.includes('not responding')) {
                    userMessage = 'CoinGecko API не відповідає. Перевірте підключення до інтернету.';
                } else if (error.message.includes('Failed to fetch')) {
                    userMessage = 'Помилка мережі. Перевірте підключення до інтернету.';
                }
                
                // Оновити статус помилки на панелі
                updateCryptoStatus(`Помилка: ${userMessage}`, 'error');
                
                const tableBody = document.getElementById('crypto-market-table');
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                ${userMessage}
                                <br><small class="text-muted">Спробуйте оновити сторінку або поверніться пізніше</small>
                            </td>
                        </tr>
                    `;
                }
                showError(userMessage);
            }
        }

        async function loadCryptoGlobal() {
            try {
                const apiUrl = '/api/crypto/global';
                
                // Оновити статус глобальних метрик
                const globalStatusEl = document.getElementById('crypto-global-status');
                if (globalStatusEl) {
                    globalStatusEl.innerHTML = '<i class="fas fa-spinner fa-spin text-info"></i> Завантаження метрик...';
                }
                
                console.log('🌍 Запит до глобальних метрик:', apiUrl);
                console.log('📡 Повний URL:', window.location.origin + apiUrl);
                
                const resp = await fetch(apiUrl);
                console.log('📊 Статус відповіді (глобальні):', resp.status, resp.statusText);
                
                const response = await resp.json();
                console.log('📋 Тип глобальних даних:', typeof response);
                
                // Handle new response format with metadata / Обробка нового формату відповіді з метаданими
                let data, lastUpdate;
                if (response.data) {
                    // New format with metadata / Новий формат з метаданими
                    data = response.data;
                    lastUpdate = response.last_update;
                } else {
                    // Old format (backward compatibility) / Старий формат (зворотна сумісність)
                    data = response;
                    lastUpdate = null;
                }
                
                console.log('📈 Глобальні дані отримано:', data ? 'так' : 'ні');
                console.log('🕒 Останнє оновлення глобальних даних:', lastUpdate || 'не відомо');
                console.log('📊 Структура відповіді:', Object.keys(response));
                
                const mcapUsd = data.total_market_cap && data.total_market_cap.usd ? data.total_market_cap.usd : null;
                const btcDom = data.market_cap_percentage && data.market_cap_percentage.btc ? data.market_cap_percentage.btc : null;
                
                if (mcapUsd != null) {
                    console.log('💰 Загальна капіталізація:', formatCurrencyByCode(mcapUsd, 'USD'));
                    document.getElementById('crypto-global-mcap').textContent = formatCurrencyByCode(mcapUsd, 'USD');
                }
                if (btcDom != null) {
                    console.log('₿ Домінування BTC:', btcDom.toFixed(2) + '%');
                    document.getElementById('crypto-global-btc').textContent = btcDom.toFixed(2) + '%';
                }
                
                // Оновити статус успіху з часом отримання
                if (globalStatusEl) {
                    const statusMessage = lastUpdate ? 
                        `<i class="fas fa-check-circle text-success"></i> Метрики отримано: ${lastUpdate}` : 
                        '<i class="fas fa-check-circle text-success"></i> Метрики оновлено';
                    globalStatusEl.innerHTML = statusMessage;
                }
                
                return response; // Повернути дані для збереження
            } catch (e) {
                console.error('❌ Помилка завантаження глобальних метрик:', e);
                
                // Визначити тип помилки
                let userMessage = 'Помилка завантаження метрик';
                if (e.message.includes('Rate limit exceeded')) {
                    userMessage = 'Ліміт запитів перевищено';
                } else if (e.message.includes('timeout') || e.message.includes('not responding')) {
                    userMessage = 'API не відповідає';
                } else if (e.message.includes('Failed to fetch')) {
                    userMessage = 'Помилка мережі';
                }
                
                // Оновити статус помилки
                const globalStatusEl = document.getElementById('crypto-global-status');
                if (globalStatusEl) {
                    globalStatusEl.innerHTML = `<i class="fas fa-exclamation-triangle text-danger"></i> ${userMessage}`;
                }
                
                return null; // Повернути null при помилці
            }
        }

        async function openCryptoCoin(coinId, coinName, symbol, currencyCode) {
            try {
                const cur = (currencyCode || 'usd');
                const apiUrl = `/api/crypto/coins/${coinId}/history?currency=${encodeURIComponent(cur)}&days=30`;
                
                console.log('🪙 Запит до історії монети:', apiUrl);
                console.log('📡 Повний URL:', window.location.origin + apiUrl);
                console.log('🏷️ Монета:', coinName, '(' + symbol + ')');
                
                const resp = await fetch(apiUrl);
                console.log('📊 Статус відповіді (історія):', resp.status, resp.statusText);
                
                const data = await resp.json();
                console.log('📋 Тип історичних даних:', typeof data);
                if (data.prices && Array.isArray(data.prices)) {
                    console.log('📈 Точок історії цін:', data.prices.length);
                }
                const prices = (data && data.prices) ? data.prices : [];
                const x = prices.map(p => new Date(p[0]));
                const y = prices.map(p => p[1]);
                const trace = { x, y, type: 'scatter', mode: 'lines', line: { color: '#4facfe' } };
                const layout = { title: `${coinName} (${symbol}) • останні 30 днів`, margin: { t: 40, r: 20, l: 50, b: 40 } };
                // Створюємо модал, якщо його немає
                let modalEl = document.getElementById('cryptoCoinModal');
                if (!modalEl) {
                    document.body.insertAdjacentHTML('beforeend', `
                        <div class="modal fade" id="cryptoCoinModal" tabindex="-1" aria-hidden="true">
                          <div class="modal-dialog modal-lg modal-dialog-centered">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title" id="crypto-coin-title">Деталі монети</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                              </div>
                              <div class="modal-body">
                                <div id="crypto-coin-chart" style="height:400px;"></div>
                              </div>
                            </div>
                          </div>
                        </div>
                    `);
                    modalEl = document.getElementById('cryptoCoinModal');
                }
                document.getElementById('crypto-coin-title').textContent = `${coinName} (${symbol})`;
                Plotly.newPlot('crypto-coin-chart', [trace], layout, { responsive: true });
                const bsModal = new bootstrap.Modal(modalEl);
                
                // Додаємо обробники подій для правильного закриття
                modalEl.addEventListener('hidden.bs.modal', function () {
                    // Очищаємо графік при закритті модального вікна
                    const chartEl = document.getElementById('crypto-coin-chart');
                    if (chartEl) {
                        Plotly.purge(chartEl);
                    }
                });
                
                bsModal.show();
            } catch (e) {
                showError('Не вдалося завантажити історію ціни монети.');
            }
        }

        // Окрема функція форматування валют з кодом (не конфліктує з глобальною UAH)
        function formatCurrencyByCode(amount, currencyCode) {
            try {
                return new Intl.NumberFormat('uk-UA', {
                    style: 'currency',
                    currency: currencyCode || 'USD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(amount ?? 0);
            } catch (e) {
                return String(amount ?? 0);
            }
        }

        // Завантаження початкових даних
        async function loadInitialData() {
            try {
                showLoading();
                
                // Завантажуємо всі дані паралельно
                const [salesRes, trendsRes, profitRes, statsRes, categoriesRes, regionsRes] = await Promise.all([
                    fetch('/api/sales?limit=5000'),
                    fetch('/api/trends'),
                    fetch('/api/profit'),
                    fetch('/api/stats'),
                    fetch('/api/categories'),
                    fetch('/api/regions')
                ]);

                currentData.sales = await salesRes.json();
                
                // Обробляємо trends з перевіркою статусу
                if (trendsRes.ok) {
                    currentData.trends = await trendsRes.json();
                } else {
                    console.warn('Помилка завантаження trends:', trendsRes.status);
                    currentData.trends = [];
                }
                
                currentData.profit = await profitRes.json();
                currentData.stats = await statsRes.json();
                
                // Перевіряємо структуру даних
                if (currentData.profit && Array.isArray(currentData.profit)) {
                    const invalidProfit = currentData.profit.filter(p => !p || !p.product_name || typeof p.product_name !== 'string');
                    if (invalidProfit.length > 0) {
                        console.warn('Знайдено невалідні записи profit:', invalidProfit.length);
                    }
                }
                
                // Логування для дебагу
                console.log('Завантажені дані:', {
                    sales: currentData.sales?.length || 0,
                    trends: currentData.trends?.length || 0,
                    profit: currentData.profit?.length || 0,
                    stats: currentData.stats ? 'OK' : 'ERROR'
                });
                
                // Детальне логування stats
                if (currentData.stats) {
                    console.log('Stats дані:', currentData.stats);
                    console.log('Total revenue:', currentData.stats.total_revenue);
                    console.log('Total profit:', currentData.stats.total_profit);
                    console.log('Total sales:', currentData.stats.total_sales);
                    console.log('Avg profit margin:', currentData.stats.avg_profit_margin);
                }

                // Заповнюємо фільтри
                const categories = await categoriesRes.json();
                const regions = await regionsRes.json();
                
                populateSelect('category-filter', categories.categories);
                populateSelect('region-filter', regions.regions);

                // Оновлюємо інтерфейс
                updateKPIPanel();
                updateCharts();
                
                // Не перевіряємо статус автоматично при старті
                
                hideLoading();
            } catch (error) {
                console.error('Помилка завантаження даних:', error);
                showError('Помилка завантаження даних: ' + error.message);
            }
        }

        // Заповнення select елементів
        function populateSelect(selectId, data) {
            const select = document.getElementById(selectId);
            if (data && Array.isArray(data)) {
                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item.charAt(0).toUpperCase() + item.slice(1);
                    select.appendChild(option);
                });
            }
        }

        // Налаштування фільтрів дат
        function setupDateFilters() {
            const today = new Date();
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
            
            document.getElementById('end-date').value = today.toISOString().split('T')[0];
            document.getElementById('start-date').value = lastMonth.toISOString().split('T')[0];
        }

        // Оновлення KPI панелі
        function updateKPIPanel() {
            const stats = currentData.stats;
            
            console.log('updateKPIPanel called with stats:', stats);
            
            if (!stats) {
                console.warn('Stats дані відсутні');
                return;
            }
            
            console.log('Updating KPI with values:', {
                total_revenue: stats.total_revenue,
                total_profit: stats.total_profit,
                total_sales: stats.total_sales,
                avg_profit_margin: stats.avg_profit_margin
            });
            
            document.getElementById('total-revenue').textContent = formatCurrency(stats.total_revenue);
            document.getElementById('total-profit').textContent = formatCurrency(stats.total_profit);
            document.getElementById('total-sales').textContent = formatNumber(stats.total_sales);
            document.getElementById('profit-margin').textContent = formatPercentage(stats.avg_profit_margin);
        }

        // Оновлення всіх графіків
        function updateCharts() {
            updateSalesChart();
            updateProductsChart();
            updateRegionsChart();
            updateProfitabilityChart();
        }

        // Графік продажів у часі
        function updateSalesChart() {
            const trends = currentData.trends;
            
            if (!trends || !Array.isArray(trends) || trends.length === 0) {
                document.getElementById('sales-chart').innerHTML = '<p>Немає даних для відображення</p>';
                return;
            }
            
            const trace = {
                x: trends.map(t => t.date),
                y: trends.map(t => t.total_revenue),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Виручка',
                line: { color: '#667eea', width: 3 },
                marker: { size: 6 }
            };

            const layout = {
                title: '',
                xaxis: { title: 'Дата' },
                yaxis: { title: 'Виручка (₴)' },
                hovermode: 'closest',
                showlegend: false,
                margin: { t: 0, b: 50, l: 50, r: 20 }
            };

            Plotly.newPlot('sales-chart', [trace], layout, {responsive: true});
        }

        // Графік топ продуктів
        function updateProductsChart() {
            const sales = currentData.sales;
            
            if (!sales || !Array.isArray(sales) || sales.length === 0) {
                document.getElementById('products-chart').innerHTML = '<p>Немає даних для відображення</p>';
                return;
            }
            
            // Групуємо за продуктами (фільтруємо валідні записи)
            const productRevenue = {};
            sales.forEach(sale => {
                if (sale && sale.product_name && typeof sale.product_name === 'string' && sale.total_revenue !== undefined) {
                    productRevenue[sale.product_name] = (productRevenue[sale.product_name] || 0) + sale.total_revenue;
                }
            });

            // Сортуємо та беремо топ-10
            const topProducts = Object.entries(productRevenue)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);

            if (topProducts.length === 0) {
                document.getElementById('products-chart').innerHTML = '<p>Немає валідних даних для відображення</p>';
                return;
            }

            const trace = {
                x: topProducts.map(([name]) => name.length > 20 ? name.substring(0, 20) + '...' : name),
                y: topProducts.map(([,revenue]) => revenue),
                type: 'bar',
                marker: { color: '#38ef7d' }
            };

            const layout = {
                title: '',
                xaxis: { title: 'Продукт' },
                yaxis: { title: 'Виручка (₴)' },
                margin: { t: 0, b: 100, l: 50, r: 20 }
            };

            Plotly.newPlot('products-chart', [trace], layout, {responsive: true});
        }

        // Графік продажів за регіонами
        function updateRegionsChart() {
            const sales = currentData.sales;
            
            if (!sales || !Array.isArray(sales) || sales.length === 0) {
                document.getElementById('regions-chart').innerHTML = '<p>Немає даних для відображення</p>';
                return;
            }
            
            // Групуємо за регіонами (фільтруємо валідні записи)
            const regionRevenue = {};
            sales.forEach(sale => {
                if (sale && sale.region && typeof sale.region === 'string' && sale.total_revenue !== undefined) {
                    regionRevenue[sale.region] = (regionRevenue[sale.region] || 0) + sale.total_revenue;
                }
            });

            if (Object.keys(regionRevenue).length === 0) {
                document.getElementById('regions-chart').innerHTML = '<p>Немає валідних даних для відображення</p>';
                return;
            }

            const trace = {
                labels: Object.keys(regionRevenue).map(r => r.charAt(0).toUpperCase() + r.slice(1)),
                values: Object.values(regionRevenue),
                type: 'pie',
                marker: {
                    colors: ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe']
                }
            };

            const layout = {
                title: '',
                margin: { t: 0, b: 50, l: 50, r: 50 }
            };

            Plotly.newPlot('regions-chart', [trace], layout, {responsive: true});
        }

        // Графік рентабельності
        function updateProfitabilityChart() {
            const profit = currentData.profit;
            
            if (!profit || !Array.isArray(profit) || profit.length === 0) {
                document.getElementById('profitability-chart').innerHTML = '<p>Немає даних для відображення</p>';
                return;
            }
            
            // Фільтруємо записи з валідними даними
            const validProfit = profit.filter(p => p && p.product_name && typeof p.product_name === 'string' && p.profit_percentage !== undefined);
            
            if (validProfit.length === 0) {
                document.getElementById('profitability-chart').innerHTML = '<p>Немає валідних даних для відображення</p>';
                return;
            }
            
            // Сортуємо за рентабельністю
            const sortedProfit = validProfit.sort((a, b) => b.profit_percentage - a.profit_percentage).slice(0, 10);

            const trace = {
                x: sortedProfit.map(p => p.product_name.length > 15 ? p.product_name.substring(0, 15) + '...' : p.product_name),
                y: sortedProfit.map(p => p.profit_percentage),
                type: 'bar',
                marker: { color: '#f5576c' }
            };

            const layout = {
                title: '',
                xaxis: { title: 'Продукт' },
                yaxis: { title: 'Рентабельність (%)' },
                margin: { t: 0, b: 100, l: 50, r: 20 }
            };

            Plotly.newPlot('profitability-chart', [trace], layout, {responsive: true});
        }

        // Застосування фільтрів
        async function applyFilters() {
            try {
                showLoading();
                
                const params = new URLSearchParams();
                
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const category = document.getElementById('category-filter').value;
                const region = document.getElementById('region-filter').value;
                
                if (startDate) params.append('start_date', startDate);
                if (endDate) params.append('end_date', endDate);
                if (category) params.append('category', category);
                if (region) params.append('region', region);
                
                params.append('limit', '5000');
                
                const response = await fetch(`/api/sales?${params}`);
                
                if (!response.ok) {
                    throw new Error(`API помилка: ${response.status} ${response.statusText}`);
                }
                
                currentData.sales = await response.json();
                
                // Перевіряємо, чи отримали масив
                if (!Array.isArray(currentData.sales)) {
                    console.warn('API повернув не масив:', currentData.sales);
                    currentData.sales = [];
                }
                
                // Оновлюємо статистику
                const statsResponse = await fetch('/api/stats');
                if (statsResponse.ok) {
                    currentData.stats = await statsResponse.json();
                } else {
                    console.warn('Помилка завантаження статистики:', statsResponse.status);
                }
                
                updateKPIPanel();
                updateCharts();
                
                hideLoading();
            } catch (error) {
                console.error('Помилка застосування фільтрів:', error);
                showError('Помилка застосування фільтрів: ' + error.message);
            }
        }

        // Очищення фільтрів
        function clearFilters() {
            document.getElementById('start-date').value = '';
            document.getElementById('end-date').value = '';
            document.getElementById('category-filter').value = '';
            document.getElementById('region-filter').value = '';
            
            loadInitialData();
        }

        // Регенерація даних
        async function regenerateData() {
            try {
                showLoading();
                
                const response = await fetch('/api/regenerate', { method: 'POST' });
                const result = await response.json();
                
                if (response.ok) {
                    await loadInitialData();
                    showSuccess('Дані успішно оновлено!');
                } else {
                    throw new Error(result.detail || 'Помилка регенерації даних');
                }
            } catch (error) {
                console.error('Помилка регенерації даних:', error);
                showError('Помилка регенерації даних: ' + error.message);
            }
        }

        // Допоміжні функції
        function formatCurrency(amount) {
            if (amount === undefined || amount === null || isNaN(amount)) {
                return '—';
            }
            return new Intl.NumberFormat('uk-UA', {
                style: 'currency',
                currency: 'UAH',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function formatNumber(number) {
            if (number === undefined || number === null || isNaN(number)) {
                return '—';
            }
            return new Intl.NumberFormat('uk-UA').format(number);
        }

        function formatPercentage(percentage) {
            if (percentage === undefined || percentage === null || isNaN(percentage)) {
                return '—';
            }
            return percentage.toFixed(1) + '%';
        }

        function showLoading() {
            document.body.style.opacity = '0.7';
            document.body.style.pointerEvents = 'none';
        }

        function hideLoading() {
            document.body.style.opacity = '1';
            document.body.style.pointerEvents = 'auto';
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.container').firstChild);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'alert alert-success';
            successDiv.textContent = message;
            document.querySelector('.container').insertBefore(successDiv, document.querySelector('.container').firstChild);
            
            setTimeout(() => successDiv.remove(), 3000);
        }

        


        // Функція для отримання назви показника
        function getIndicatorName(indicator) {
            const names = {
                'GDP': 'ВВП',
                'GDP_PER_CAPITA': 'ВВП на душу',
                'INFLATION': 'Інфляція',
                'UNEMPLOYMENT': 'Безробіття',
                'EXPORTS': 'Експорт',
                'IMPORTS': 'Імпорт',
                'POPULATION': 'Населення',
                'LIFE_EXPECTANCY': 'Тривалість життя',
                'INTERNET_USERS': 'Користувачі інтернету',
                'EDUCATION_EXPENDITURE': 'Витрати на освіту'
            };
            return names[indicator] || indicator;
        }

        // Функції для роботи з файлами
        let currentFile = null;
        let currentOffset = 0;
        const pageSize = 50;

        async function loadFilesList() {
            try {
                console.log('Завантаження списку файлів...');
                const response = await fetch('/api/files');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('Отримані файли:', result);
                
                const filesList = document.getElementById('files-list');
                if (!filesList) {
                    console.error('Елемент files-list не знайдено!');
                    return;
                }
                
                filesList.innerHTML = '';
                
                if (result.files && Array.isArray(result.files)) {
                    console.log('Обробка файлів:', result.files.length);
                    result.files.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'list-group-item list-group-item-action';
                    fileItem.style.cursor = 'pointer';
                    fileItem.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${file.name}</h6>
                            <div>
                                <button class="btn btn-sm btn-outline-info me-2" onclick="event.stopPropagation(); showFileStats('${file.name}')" title="Статистика">
                                    <i class="fas fa-chart-bar"></i>
                                </button>
                                <small>${formatFileSize(file.size)}</small>
                            </div>
                        </div>
                        <p class="mb-1">Модифіковано: ${new Date(file.modified).toLocaleString('uk-UA')}</p>
                    `;
                    
                    fileItem.addEventListener('click', () => loadFileContent(file.name));
                    filesList.appendChild(fileItem);
                });
                } else {
                    console.log('Немає файлів для відображення');
                    filesList.innerHTML = '<div class="list-group-item text-muted">Файли не знайдені</div>';
                }
                console.log('Завантаження файлів завершено');
            } catch (error) {
                console.error('Помилка завантаження списку файлів:', error);
                showError('Помилка завантаження списку файлів: ' + error.message);
                document.getElementById('files-list').innerHTML = '<div class="list-group-item text-danger">Помилка завантаження файлів</div>';
            }
        }

        async function loadFileContent(filename, offset = 0) {
            try {
                currentFile = filename;
                currentOffset = offset;
                
                const response = await fetch(`/api/files/${filename}?limit=${pageSize}&offset=${offset}`);
                const result = await response.json();
                
                displayFileContent(result);
                updatePagination(result);
            } catch (error) {
                console.error('Помилка завантаження вмісту файлу:', error);
                showError('Помилка завантаження вмісту файлу: ' + error.message);
            }
        }

        function displayFileContent(fileData) {
            const contentDiv = document.getElementById('file-content');
            
            if (!fileData.data || fileData.data.length === 0) {
                contentDiv.innerHTML = '<p class="text-muted">Файл порожній</p>';
                return;
            }
            
            // Створюємо таблицю
            let tableHtml = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                ${fileData.columns.map(col => `<th>${col}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            fileData.data.forEach(row => {
                tableHtml += '<tr>';
                fileData.columns.forEach(col => {
                    const value = row[col];
                    const displayValue = value === null || value === undefined ? '-' : value;
                    tableHtml += `<td>${displayValue}</td>`;
                });
                tableHtml += '</tr>';
            });
            
            tableHtml += `
                        </tbody>
                    </table>
                </div>
                <div class="mt-2">
                    <small class="text-muted">
                        Показано ${fileData.offset + 1}-${fileData.offset + fileData.data.length} з ${fileData.total_rows} записів
                    </small>
                </div>
            `;
            
            contentDiv.innerHTML = tableHtml;
        }

        function updatePagination(fileData) {
            const paginationDiv = document.getElementById('file-pagination');
            const totalPages = Math.ceil(fileData.total_rows / pageSize);
            const currentPage = Math.floor(fileData.offset / pageSize) + 1;
            
            if (totalPages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }
            
            let paginationHtml = '<nav><ul class="pagination pagination-sm">';
            
            // Кнопка "Попередня"
            if (currentPage > 1) {
                paginationHtml += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="loadFileContent('${currentFile}', ${(currentPage - 2) * pageSize})">Попередня</a>
                    </li>
                `;
            }
            
            // Номери сторінок
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentPage ? 'active' : '';
                paginationHtml += `
                    <li class="page-item ${isActive}">
                        <a class="page-link" href="#" onclick="loadFileContent('${currentFile}', ${(i - 1) * pageSize})">${i}</a>
                    </li>
                `;
            }
            
            // Кнопка "Наступна"
            if (currentPage < totalPages) {
                paginationHtml += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="loadFileContent('${currentFile}', ${currentPage * pageSize})">Наступна</a>
                    </li>
                `;
            }
            
            paginationHtml += '</ul></nav>';
            paginationDiv.innerHTML = paginationHtml;
        }

        async function showFileStats(filename) {
            try {
                const response = await fetch(`/api/files/${filename}/stats`);
                const stats = await response.json();
                
                let statsHtml = `
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Статистика файлу: ${stats.filename}</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Рядків:</strong> ${stats.total_rows.toLocaleString()}</p>
                                    <p><strong>Колонок:</strong> ${stats.total_columns}</p>
                                    <p><strong>Розмір в пам'яті:</strong> ${formatFileSize(stats.memory_usage)}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Колонки:</strong></p>
                                    <ul class="list-unstyled">
                                        ${stats.columns.map(col => `<li><code>${col}</code> (${stats.data_types[col]})</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                `;
                
                if (stats.numeric_stats) {
                    statsHtml += `
                        <div class="mt-3">
                            <h6>Статистика числових колонок:</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Колонка</th>
                                            <th>Мін</th>
                                            <th>Макс</th>
                                            <th>Середнє</th>
                                            <th>Медіана</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    Object.keys(stats.numeric_stats).forEach(col => {
                        const colStats = stats.numeric_stats[col];
                        statsHtml += `
                            <tr>
                                <td><code>${col}</code></td>
                <td>${typeof colStats.min === 'number' ? colStats.min.toFixed(2) : (colStats.min ? parseFloat(colStats.min).toFixed(2) : '-')}</td>
                <td>${typeof colStats.max === 'number' ? colStats.max.toFixed(2) : (colStats.max ? parseFloat(colStats.max).toFixed(2) : '-')}</td>
                <td>${typeof colStats.mean === 'number' ? colStats.mean.toFixed(2) : (colStats.mean ? parseFloat(colStats.mean).toFixed(2) : '-')}</td>
                <td>${typeof colStats['50%'] === 'number' ? colStats['50%'].toFixed(2) : (colStats['50%'] ? parseFloat(colStats['50%']).toFixed(2) : '-')}</td>
                            </tr>
                        `;
                    });
                    
                    statsHtml += '</tbody></table></div>';
                }
                
                statsHtml += '</div></div>';
                
                // Показуємо статистику в модальному вікні
                const modalHtml = `
                    <div class="modal fade" id="statsModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Статистика файлу</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    ${statsHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Видаляємо попередній модаль, якщо існує
                const existingModal = document.getElementById('statsModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Додаємо новий модаль
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Показуємо модаль
                const modal = new bootstrap.Modal(document.getElementById('statsModal'));
                modal.show();
                
            } catch (error) {
                console.error('Помилка завантаження статистики файлу:', error);
                showError('Помилка завантаження статистики файлу: ' + error.message);
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Функції для роботи з даними Світового банку
        let worldBankData = null;
        let availableCountries = {};
        let availableIndicators = {};

        // Ініціалізація даних Світового банку
        async function initializeWorldBankData() {
            try {
                console.log('🌍 Ініціалізація World Bank даних...');
                
                // Завантажуємо списки країн та показників
                const [countriesResponse, indicatorsResponse] = await Promise.all([
                    fetch('/api/worldbank/countries'),
                    fetch('/api/worldbank/indicators-list')
                ]);

                console.log('📡 Отримано відповіді:', countriesResponse.status, indicatorsResponse.status);

                const countriesData = await countriesResponse.json();
                const indicatorsData = await indicatorsResponse.json();

                console.log('📋 Дані країн:', countriesData);
                console.log('📊 Дані показників:', indicatorsData);

                availableCountries = countriesData.countries;
                availableIndicators = indicatorsData.indicators;

                console.log('✅ Змінні встановлено:', Object.keys(availableCountries).length, 'країн,', Object.keys(availableIndicators).length, 'показників');

                // Заповнюємо селекти
                populateWorldBankSelects();
                console.log('🎯 Селекти заповнено');

            } catch (error) {
                console.error('❌ Помилка ініціалізації даних Світового банку:', error);
                showError('Помилка завантаження списків країн та показників');
            }
        }

        function populateWorldBankSelects() {
            console.log('🔧 Заповнення селектів World Bank...');
            
            // Заповнюємо селект країн
            const countriesSelect = document.getElementById('worldbank-countries');
            if (!countriesSelect) {
                console.error('❌ Селект країн не знайдено!');
                return;
            }
            
            countriesSelect.innerHTML = '';
            console.log('📋 Доступні країни:', availableCountries);
            
            Object.entries(availableCountries).forEach(([code, name]) => {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${name} (${code})`;
                countriesSelect.appendChild(option);
            });
            console.log('✅ Додано', Object.keys(availableCountries).length, 'країн');

            // Заповнюємо селект показників
            const indicatorsSelect = document.getElementById('worldbank-indicators');
            if (!indicatorsSelect) {
                console.error('❌ Селект показників не знайдено!');
                return;
            }
            
            indicatorsSelect.innerHTML = '';
            console.log('📊 Доступні показники:', availableIndicators);
            
            Object.entries(availableIndicators).forEach(([key, code]) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = key.replace(/_/g, ' ');
                indicatorsSelect.appendChild(option);
            });
            console.log('✅ Додано', Object.keys(availableIndicators).length, 'показників');
        }

        async function loadWorldBankData() {
            try {
                const countries = Array.from(document.getElementById('worldbank-countries').selectedOptions)
                    .map(option => option.value);
                const indicators = Array.from(document.getElementById('worldbank-indicators').selectedOptions)
                    .map(option => option.value);
                const startYear = document.getElementById('worldbank-start-year').value;
                const endYear = document.getElementById('worldbank-end-year').value;

                // Валідація вибору
                if (countries.length === 0 && indicators.length === 0) {
                    showTabStatus('indicators', 'error', 'Оберіть параметри', 'Оберіть принаймні одну країну і один показник');
                    showError('Оберіть країни та показники для завантаження');
                    return;
                }
                if (countries.length === 0) {
                    showTabStatus('indicators', 'error', 'Оберіть країни', 'Оберіть принаймні одну країну');
                    showError('Оберіть хоча б одну країну');
                    return;
                }
                if (indicators.length === 0) {
                    showTabStatus('indicators', 'error', 'Оберіть показники', 'Оберіть принаймні один показник');
                    showError('Оберіть хоча б один показник');
                    return;
                }
                if (!startYear || !endYear || Number(startYear) > Number(endYear)) {
                    showTabStatus('indicators', 'error', 'Невірний період', 'Перевірте значення років');
                    showError('Невірний період: перевірте роки початку та завершення');
                    return;
                }

                // Показуємо статус завантаження після валідації
                showWorldBankStatus('info', 'Завантаження...', 'Відправляємо запит до API');
                showTabStatus('indicators', 'info', 'Завантаження...', 'Відправляємо запит до API');

                const params = new URLSearchParams();
                if (countries.length > 0) params.append('countries', countries.join(','));
                if (indicators.length > 0) params.append('indicators', indicators.join(','));
                params.append('start_year', startYear);
                params.append('end_year', endYear);

                const response = await fetch(`/api/worldbank/indicators?${params}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();

                worldBankData = result;
                updateWorldBankIndicatorsChart(result);
                updateWorldBankIndicatorsTable(result);
                
                // Створюємо ключ для кешування та зберігаємо дані
                const cacheKey = `indicators_${countries.join('_')}_${indicators.join('_')}_${startYear}_${endYear}`;
                saveWorldBankDataToStorage(cacheKey, result);
                
                // Оновлюємо статус з часом отримання даних
                const lastUpdate = result.last_update;
                const statusMessage = lastUpdate ? 
                    `Дані отримано: ${lastUpdate}` : 
                    'Дані завантажено';
                updateWorldBankStatus(statusMessage, 'success');
                
                // Перевіряємо статус даних (індикатор у панелі Світового банку)
                const rows = (result && result.data) ? result.data : result;
                const count = rows && rows.length ? rows.length : 0;
                if (rows && count > 0) {
                    const firstItem = rows[0];
                    // Перевіряємо чи це зразкові дані (GDP = 200 для України)
                    if (firstItem.Country_Name === 'Ukraine' && firstItem.GDP === 200) {
                        showWorldBankStatus('warning', 
                            'API недоступний', 
                            'Використовуються зразкові дані для демонстрації');
                        showTabStatus('indicators', 'success', 
                            'Дані завантажено', 
                            `Отримано записів: ${count}`);
                    } else {
                        showWorldBankStatus('success', 
                            'API працює', 
                            'Дані успішно отримано з Світового банку');
                        showTabStatus('indicators', 'success', 
                            'Дані завантажено', 
                            `Отримано записів: ${count}`);
                    }
                }

            } catch (error) {
                console.error('Помилка завантаження даних Світового банку:', error);
                
                // Спробувати завантажити збережені дані
                const countries = Array.from(document.getElementById('worldbank-countries').selectedOptions)
                    .map(option => option.value);
                const indicators = Array.from(document.getElementById('worldbank-indicators').selectedOptions)
                    .map(option => option.value);
                const startYear = document.getElementById('worldbank-start-year').value;
                const endYear = document.getElementById('worldbank-end-year').value;
                
                const cacheKey = `indicators_${countries.join('_')}_${indicators.join('_')}_${startYear}_${endYear}`;
                const savedData = loadWorldBankDataFromStorage(cacheKey);
                
                if (savedData && savedData[cacheKey]) {
                    console.log('📂 Використовуємо збережені дані World Bank');
                    worldBankData = savedData[cacheKey];
                    updateWorldBankIndicatorsChart(savedData[cacheKey]);
                    updateWorldBankIndicatorsTable(savedData[cacheKey]);
                    
                    // Відображаємо статус з часом отримання даних
                    const lastUpdate = savedData[cacheKey].last_update;
                    const statusMessage = lastUpdate ? 
                        `Збережені дані (отримано: ${lastUpdate})` : 
                        'Збережені дані';
                    updateWorldBankStatus(statusMessage, 'info'); 
                    showTabStatus('indicators', 'success', 
                        'Збережені дані', 
                        `Завантажено ${count} записів (збережено ${savedData.savedAt})`);
                } else {
                    showError('Помилка завантаження даних Світового банку: ' + error.message);
                    showWorldBankStatus('error', 'Помилка API', 'Не вдалося отримати дані з Світового банку');
                    showTabStatus('indicators', 'error', 'Помилка завантаження', 'Не вдалося завантажити дані показників');
                }
            }
        }

        function updateWorldBankIndicatorsChart(data) {
            if (!data.data || data.data.length === 0) {
                document.getElementById('worldbank-indicators-chart').innerHTML = '<p class="text-muted">Немає даних для відображення</p>';
                return;
            }

            // Групуємо дані за країнами та роками
            const chartData = {};
            data.data.forEach(row => {
                const country = row.Country_Name;
                const year = row.Year;
                
                if (!chartData[country]) {
                    chartData[country] = {};
                }
                chartData[country][year] = row;
            });

            // Створюємо графік (більш наглядний вигляд)
            const traces = [];
            Object.entries(chartData).forEach(([country, years]) => {
                const sortedYears = Object.keys(years).sort();
                const gdpData = sortedYears.map(year => years[year].GDP || 0);

                traces.push({
                    x: sortedYears,
                    y: gdpData,
                    name: country,
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { shape: 'spline', width: 3 },
                    marker: { size: 6 },
                    hovertemplate: `${country}<br>Рік: %{x}<br>ВВП: %{y:,.2f} USD<extra></extra>`
                });
            });

            // Динамічний діапазон осі Y
            let yMin = Infinity;
            let yMax = -Infinity;
            traces.forEach(trace => {
                (trace.y || []).forEach(val => {
                    if (val !== null && val !== undefined) {
                        if (val < yMin) yMin = val;
                        if (val > yMax) yMax = val;
                    }
                });
            });
            const yRange = (yMax - yMin) || 1;
            const yBuffer = yRange * 0.1;
            const finalYMin = yMin === Infinity ? 0 : yMin - yBuffer;
            const finalYMax = yMax === -Infinity ? 1 : yMax + yBuffer;

            const layout = {
                title: 'ВВП країн у часі',
                xaxis: { title: 'Рік', rangeslider: { visible: true } },
                yaxis: { title: 'ВВП (USD)', tickformat: ',.2s', gridcolor: '#e9ecef', range: [finalYMin, finalYMax] },
                hovermode: 'x unified',
                legend: { orientation: 'h', y: -0.2 },
                margin: { t: 40, r: 20, l: 60, b: 60 }
            };

            Plotly.newPlot('worldbank-indicators-chart', traces, layout);
        }

        function updateWorldBankIndicatorsTable(data) {
            const tbody = document.querySelector('#worldbank-indicators-table tbody');
            tbody.innerHTML = '';

            if (!data.data || data.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-muted">Немає даних для відображення</td></tr>';
                return;
            }

            data.data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.Country_Name}</td>
                    <td>${row.Year}</td>
                    <td>${row.GDP ? row.GDP.toLocaleString() : '-'}</td>
                    <td>${row.GDP_PER_CAPITA ? row.GDP_PER_CAPITA.toLocaleString() : '-'}</td>
                    <td>${(typeof row.INFLATION === 'number' ? row.INFLATION.toFixed(2) : (row.INFLATION ? parseFloat(row.INFLATION).toFixed(2) : '-'))}${(row.INFLATION || row.INFLATION === 0) ? '%' : ''}</td>
                    <td>${(typeof row.UNEMPLOYMENT === 'number' ? row.UNEMPLOYMENT.toFixed(2) : (row.UNEMPLOYMENT ? parseFloat(row.UNEMPLOYMENT).toFixed(2) : '-'))}${(row.UNEMPLOYMENT || row.UNEMPLOYMENT === 0) ? '%' : ''}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function loadComparisonData() {
            try {
                const countries = document.getElementById('comparison-countries').value;
                const indicator = document.getElementById('comparison-indicator').value;
                const years = document.getElementById('comparison-years').value;

                // Перевіряємо чи вибрані необхідні фільтри
                if (!countries) {
                    showTabStatus('comparison', 'error', 'Оберіть країни', 'Для порівняння потрібно вибрати принаймні дві країни');
                    return;
                }

                if (!indicator) {
                    showTabStatus('comparison', 'error', 'Оберіть показник', 'Для порівняння потрібно вибрати показник');
                    return;
                }

                // Показуємо статус завантаження
                showWorldBankStatus('info', 'Завантаження...', 'Отримуємо дані для порівняння країн...');
                showTabStatus('comparison', 'info', 'Завантаження...', 'Отримуємо дані для порівняння країн...');

                const params = new URLSearchParams();
                params.append('countries', countries);
                params.append('indicator', indicator);
                params.append('years', years);

                const response = await fetch(`/api/worldbank/comparison?${params}`);
                const result = await response.json();

                updateComparisonChart(result);
                
                if (result.data && result.data.length > 0) {
                    showWorldBankStatus('success', 'API працює', 'Дані успішно отримано з Світового банку');
                    showTabStatus('comparison', 'success', 'Порівняння завершено', `Проаналізовано ${result.data.length} записів`);
                } else {
                    showWorldBankStatus('warning', 'API недоступний', 'Використовуються зразкові дані для демонстрації');
                    showTabStatus('comparison', 'success', 'Порівняння завершено', `Проаналізовано ${result.data.length} записів`);
                }

            } catch (error) {
                console.error('Помилка завантаження даних порівняння:', error);
                showError('Помилка завантаження даних порівняння: ' + error.message);
                showWorldBankStatus('error', 'Помилка API', 'Не вдалося отримати дані з Світового банку');
                showTabStatus('comparison', 'error', 'Помилка порівняння', 'Не вдалося виконати порівняння країн');
            }
        }

        function updateComparisonChart(data) {
            if (!data.data || data.data.length === 0) {
                document.getElementById('worldbank-comparison-chart').innerHTML = '<p class="text-muted">Немає даних для відображення</p>';
                return;
            }

            // Групуємо дані за країнами
            const chartData = {};
            data.data.forEach(row => {
                const country = row.Country_Name;
                if (!chartData[country]) {
                    chartData[country] = [];
                }
                chartData[country].push({
                    year: row.Year,
                    value: row.Value
                });
            });

            // Створюємо графік
            const traces = [];
            Object.entries(chartData).forEach(([country, values]) => {
                const sortedValues = values.sort((a, b) => a.year - b.year);
                
                traces.push({
                    x: sortedValues.map(v => v.year),
                    y: sortedValues.map(v => v.value),
                    name: country,
                    type: 'scatter',
                    mode: 'lines+markers'
                });
            });

            const layout = {
                title: `Порівняння країн: ${data.indicator}`,
                xaxis: { title: 'Рік' },
                yaxis: { title: 'Значення' },
                hovermode: 'closest'
            };

            Plotly.newPlot('worldbank-comparison-chart', traces, layout);
        }

        async function loadTrendsData() {
            try {
                const country = document.getElementById('trends-country').value;
                const indicators = Array.from(document.getElementById('trends-indicators').selectedOptions)
                    .map(option => option.value);
                const years = document.getElementById('trends-years').value;

                // Перевіряємо чи вибрані необхідні фільтри
                if (!country) {
                    showTabStatus('trends', 'error', 'Оберіть країну', 'Для аналізу трендів потрібно вибрати країну');
                    return;
                }

                if (indicators.length === 0) {
                    showTabStatus('trends', 'error', 'Оберіть показники', 'Для аналізу трендів потрібно вибрати принаймні один показник');
                    return;
                }

                // Показуємо статус завантаження
                showWorldBankStatus('info', 'Завантаження...', 'Отримуємо дані з API Світового банку...');
                showTabStatus('trends', 'info', 'Завантаження...', 'Отримуємо дані з API Світового банку...');

                const params = new URLSearchParams();
                if (indicators.length > 0) params.append('indicators', indicators.join(','));
                params.append('years', years);

                const response = await fetch(`/api/worldbank/trends/${country}?${params}`);
                const result = await response.json();

                updateTrendsChart(result);
                updateTrendsAnalysis(result);

                // Оновлюємо статус після успішного аналізу
                if (result.trends && Object.keys(result.trends).length > 0) {
                    const count = Object.keys(result.trends).length;
                    // Перевіряємо чи це зразкові дані (завжди Україна з певними значеннями)
                    const isSampleData = result.country === 'Україна' && 
                                        result.trends.GDP && 
                                        result.trends.GDP.latest_value === 200;
                    
                    if (isSampleData) {
                        showWorldBankStatus('warning', 
                            'API недоступний', 
                            'Використовуються зразкові дані для демонстрації');
                        showTabStatus('trends', 'success', 
                            'Аналіз завершено', 
                            `Проаналізовано показників: ${count} для ${result.country}`);
                    } else {
                        showWorldBankStatus('success', 
                            'API працює', 
                            'Дані успішно отримано з Світового банку');
                        showTabStatus('trends', 'success', 
                            'Аналіз завершено', 
                            `Проаналізовано показників: ${count} для ${result.country}`);
                    }
                } else {
                    showWorldBankStatus('error', 
                        'Немає даних для аналізу', 
                        'Не вдалося отримати дані для аналізу трендів.');
                    showTabStatus('trends', 'error', 
                        'Немає даних', 
                        'Не вдалося отримати дані для аналізу трендів.');
                }

            } catch (error) {
                console.error('Помилка завантаження даних трендів:', error);
                showError('Помилка завантаження даних трендів: ' + error.message);
                
                // Детальна інформація про помилку
                let errorDetails = error.message;
                if (error.message.includes('APIError')) {
                    errorDetails = 'API Світового банку повертає некоректні дані. Перевірте логи сервера для деталей.';
                } else if (error.message.includes('JSON')) {
                    errorDetails = 'Помилка парсингу JSON від API. Можливо, сервер тимчасово недоступний.';
                } else if (error.message.includes('timeout')) {
                    errorDetails = 'Тайм-аут запиту до API. Спробуйте зменшити кількість років аналізу.';
                }
                
                showWorldBankStatus('error', 'Помилка API', errorDetails);
                showTabStatus('trends', 'error', 'Помилка аналізу', 'Не вдалося виконати аналіз трендів');
            }
        }

        function updateTrendsChart(data) {
            if (!data.raw_data || data.raw_data.length === 0) {
                document.getElementById('worldbank-trends-chart').innerHTML = '<p class="text-muted">Немає даних для відображення</p>';
                return;
            }

            // Створюємо графік з кількома показниками
            const traces = [];
            const indicators = Object.keys(data.trends || {});
            
            indicators.forEach(indicator => {
                const values = data.raw_data
                    .filter(row => row[indicator] !== null && row[indicator] !== undefined)
                    .sort((a, b) => a.Year - b.Year);
                
                if (values.length > 0) {
                    traces.push({
                        x: values.map(v => v.Year),
                        y: values.map(v => v[indicator]),
                        name: indicator.replace(/_/g, ' '),
                        type: 'scatter',
                        mode: 'lines+markers',
                        yaxis: 'y' + (traces.length > 0 ? traces.length + 1 : '')
                    });
                }
            });

            const layout = {
                title: `Тренди для ${data.country}`,
                xaxis: { title: 'Рік' },
                hovermode: 'closest'
            };

            // Додаємо осі для кожного показника
            indicators.forEach((indicator, index) => {
                if (index > 0) {
                    layout[`yaxis${index + 1}`] = {
                        title: indicator.replace(/_/g, ' '),
                        overlaying: 'y',
                        side: 'right'
                    };
                } else {
                    layout.yaxis = {
                        title: indicator.replace(/_/g, ' ')
                    };
                }
            });

            Plotly.newPlot('worldbank-trends-chart', traces, layout);
        }

        function updateTrendsAnalysis(data) {
            const analysisDiv = document.getElementById('trends-analysis');
            
            if (!data.trends || Object.keys(data.trends).length === 0) {
                analysisDiv.innerHTML = '<p class="text-muted">Немає даних для аналізу</p>';
                return;
            }

            let analysisHtml = `
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Аналіз трендів для ${data.country}</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
            `;

            Object.entries(data.trends).forEach(([indicator, trend]) => {
                const directionClass = trend.direction === 'зростання' ? 'text-success' : 'text-danger';
                const directionIcon = trend.direction === 'зростання' ? 'fa-arrow-up' : 'fa-arrow-down';
                
                analysisHtml += `
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">${indicator.replace(/_/g, ' ')}</h6>
                                <p class="card-text">
                                    <i class="fas ${directionIcon} ${directionClass} me-1"></i>
                                    <strong>Тренд:</strong> <span class="${directionClass}">${trend.direction}</span><br>
                                    <strong>Останнє значення:</strong> ${trend.latest_value?.toLocaleString() || 'N/A'}<br>
                                    <strong>Років проаналізовано:</strong> ${trend.years_analyzed}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            });

            analysisHtml += `
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                Період аналізу: ${data.analysis_period}
                            </small>
                        </div>
                    </div>
                </div>
            `;

            analysisDiv.innerHTML = analysisHtml;
        }
        
        // Функція для завантаження нормалізованих даних
        async function loadNormalizedData() {
            console.log('Запуск loadNormalizedData...');
            const countries = Array.from(document.getElementById('normalized-countries').selectedOptions).map(option => option.value);
            const indicators = Array.from(document.getElementById('normalized-indicators').selectedOptions).map(option => option.value);
            const currency = document.getElementById('normalized-currency').value;
            const startYear = document.getElementById('normalized-start-year').value;
            const endYear = document.getElementById('normalized-end-year').value;
            
            console.log('Параметри:', { countries, indicators, currency, startYear, endYear });
            
            if (countries.length === 0 || indicators.length === 0) {
                showTabStatus('normalized', 'error', 'Оберіть параметри', 'Оберіть країни та показники');
                showError('Будь ласка, оберіть країни та показники');
                return;
            }
            
            try {
                // Показуємо статус завантаження після валідації
                showWorldBankStatus('info', 'Завантаження...', 'Нормалізуємо дані');
                showTabStatus('normalized', 'info', 'Завантаження...', 'Нормалізуємо дані');
                showLoading();
                
                const params = new URLSearchParams({
                    countries: countries.join(','),
                    indicators: indicators.join(','),
                    start_year: startYear,
                    end_year: endYear,
                    currency: currency
                });
                
                const response = await fetch(`/api/worldbank/normalized?${params}`);
                const result = await response.json();
                
                if (response.ok) {
                    console.log('Отримані дані:', result);
                    updateNormalizedChart(result.data, result.normalization_info, currency);
                    updateNormalizedTable(result.data, result.normalization_info);
                    
                    // Перевіряємо статус даних (індикатор у панелі Світового банку)
                    if (result.data && result.data.length > 0) {
                        const firstItem = result.data[0];
                        const count = result.total_records || result.data.length;
                        // Перевіряємо чи це зразкові дані (GDP = 200 для України)
                        if (firstItem.Country_Name === 'Ukraine' && firstItem.GDP === 200) {
                            showWorldBankStatus('warning', 
                                'API недоступний', 
                                'Використовуються зразкові дані для демонстрації');
                            showTabStatus('normalized', 'success', 
                                'Нормалізація завершена', 
                                `Оброблено записів: ${count}`);
                        } else {
                            showWorldBankStatus('success', 
                                'API працює', 
                                'Дані успішно отримано з Світового банку');
                            showTabStatus('normalized', 'success', 
                                'Нормалізація завершена', 
                                `Оброблено записів: ${count}`);
                        }
                    }
                } else {
                    console.error('Помилка відповіді:', result);
                    showError(result.detail || 'Помилка завантаження нормалізованих даних');
                    showWorldBankStatus('error', 'Дані недоступні', 'Не вдалося завантажити дані з API Світового банку.');
                }
            } catch (error) {
                showError('Помилка завантаження нормалізованих даних: ' + error.message);
                showWorldBankStatus('error', 'Помилка завантаження', 'Не вдалося завантажити нормалізовані дані: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Функція для оновлення графіка нормалізованих даних
        function updateNormalizedChart(data, normalizationInfo, currency) {
            console.log('updateNormalizedChart викликано з:', { data, normalizationInfo, currency });
            
            if (!data || data.length === 0) {
                console.log('Дані порожні, показуємо порожній графік');
                Plotly.newPlot('normalized-chart', [], {}, {responsive: true});
                return;
            }
            
            const traces = [];
            const countries = [...new Set(data.map(item => item.Country_Name))];
            const indicators = Object.keys(normalizationInfo);
            
            console.log('Країни:', countries);
            console.log('Показники:', indicators);
            
            indicators.forEach(indicator => {
                if (indicator === 'Country' || indicator === 'Country_Name' || indicator === 'Year') return;
                
                const trace = {
                    x: countries,
                    y: countries.map(country => {
                        const countryData = data.find(item => item.Country_Name === country);
                        return countryData ? countryData[indicator] : null;
                    }),
                    type: 'bar',
                    name: getIndicatorName(indicator),
                    text: countries.map(country => {
                        const countryData = data.find(item => item.Country_Name === country);
                        return countryData ? `${countryData[indicator]} ${normalizationInfo[indicator]}` : '';
                    }),
                    textposition: 'auto'
                };
                
                traces.push(trace);
            });
            
            console.log('Створені traces:', traces);
            
            const layout = {
                title: `Нормалізовані економічні показники (${currency})`,
                xaxis: { title: 'Країни' },
                yaxis: { title: 'Значення' },
                barmode: 'group',
                responsive: true
            };
            
            Plotly.newPlot('normalized-chart', traces, layout, {responsive: true});
        }
        
        // Функція для оновлення таблиці нормалізованих даних
        function updateNormalizedTable(data, normalizationInfo) {
            const tableDiv = document.getElementById('normalized-table');
            
            if (!data || data.length === 0) {
                tableDiv.innerHTML = '<div class="alert alert-warning">Немає даних для відображення</div>';
                return;
            }
            
            let html = '<div class="card"><div class="card-header"><h6 class="mb-0">Нормалізовані дані</h6></div><div class="card-body"><div class="table-responsive"><table class="table table-striped"><thead><tr>';
            
            // Заголовки таблиці
            html += '<th>Країна</th><th>Рік</th>';
            Object.keys(normalizationInfo).forEach(indicator => {
                html += `<th>${getIndicatorName(indicator)} (${normalizationInfo[indicator]})</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // Дані таблиці
            data.forEach(row => {
                html += `<tr><td>${row.Country_Name}</td><td>${row.Year}</td>`;
                Object.keys(normalizationInfo).forEach(indicator => {
                    const raw = row[indicator];
                    let valueText = 'N/A';
                    if (raw !== null && raw !== undefined && raw !== '') {
                        const num = typeof raw === 'number' ? raw : parseFloat(raw);
                        valueText = isNaN(num) ? String(raw) : num.toFixed(2);
                    }
                    html += `<td>${valueText}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div></div></div>';
            tableDiv.innerHTML = html;
        }
        
        // Функція для завантаження аналізу економічного здоров'я
        async function loadEconomicHealth() {
            const countries = Array.from(document.getElementById('health-countries').selectedOptions).map(option => option.value);
            const startYear = document.getElementById('health-start-year').value;
            const endYear = document.getElementById('health-end-year').value;
            
            if (countries.length === 0) {
                showTabStatus('health', 'error', 'Оберіть країни', 'Оберіть країни для аналізу');
                showError('Будь ласка, оберіть країни для аналізу');
                return;
            }
            
            try {
                // Показуємо статус завантаження після валідації
                showWorldBankStatus('info', 'Завантаження...', 'Аналізуємо економічне здоров\'я');
                showTabStatus('health', 'info', 'Завантаження...', 'Аналізуємо економічне здоров\'я');
                showLoading();
                
                const params = new URLSearchParams({
                    countries: countries.join(','),
                    start_year: startYear,
                    end_year: endYear
                });
                
                const response = await fetch(`/api/worldbank/economic-health?${params}`);
                const result = await response.json();
                
                if (response.ok) {
                    updateHealthChart(result.analysis);
                    updateHealthAnalysis(result.analysis, result.methodology);
                    
                    // Перевіряємо статус даних (індикатор у панелі Світового банку)
                    if (result.analysis && Object.keys(result.analysis).length > 0) {
                        const firstCountry = Object.values(result.analysis)[0];
                        const count = Object.keys(result.analysis).length;
                        if (firstCountry.country_name === 'Ukraine' || firstCountry.country_name === 'USA') {
                            showWorldBankStatus('warning', 
                                'API недоступний', 
                                'Використовуються зразкові дані для демонстрації');
                            showTabStatus('health', 'success', 
                                'Аналіз завершено', 
                                `Опрацьовано країн: ${count}`);
                        } else {
                            showWorldBankStatus('success', 
                                'API працює', 
                                'Дані успішно отримано з Світового банку');
                            showTabStatus('health', 'success', 
                                'Аналіз завершено', 
                                `Опрацьовано країн: ${count}`);
                        }
                    }
                } else {
                    showError(result.detail || "Помилка аналізу економічного здоров'я");
                    showWorldBankStatus('error', 'Дані недоступні', 'Не вдалося отримати аналіз економічного здоров\'я.');
                }
            } catch (error) {
                showError("Помилка аналізу економічного здоров'я: " + error.message);
                showWorldBankStatus('error', 'Помилка завантаження', 'Не вдалося проаналізувати економічне здоров\'я: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Функція для оновлення графіка економічного здоров'я
        function updateHealthChart(analysis) {
            if (!analysis || Object.keys(analysis).length === 0) {
                Plotly.newPlot('health-chart', [], {}, {responsive: true});
                return;
            }
            
            const countries = Object.keys(analysis).map(code => analysis[code].country_name);
            const scores = Object.keys(analysis).map(code => analysis[code].health_score);
            const levels = Object.keys(analysis).map(code => analysis[code].health_level);
            
            // Кольори залежно від рівня здоров'я (підтримка UA/EN)
            const colors = levels.map(level => {
                switch(level) {
                    case 'Відмінний':
                    case 'Excellent':
                        return '#28a745'; // green
                    case 'Добрий':
                    case 'Good':
                        return '#17a2b8'; // teal
                    case 'Середній':
                    case 'Medium':
                        return '#ffc107'; // yellow
                    case 'Поганий':
                    case 'Poor':
                        return '#fd7e14'; // orange
                    case 'Критичний':
                    case 'Critical':
                        return '#dc3545'; // red
                    case 'No Data':
                        return '#6c757d'; // gray
                    default:
                        return '#6c757d';
                }
            });
            
            const trace = {
                x: countries,
                y: scores,
                type: 'bar',
                marker: { color: colors },
                text: levels,
                textposition: 'auto'
            };
            
            const layout = {
                title: "Індекс економічного здоров'я країн",
                xaxis: { title: 'Країни' },
                yaxis: { title: 'Бал (0-100)', range: [0, 100] },
                responsive: true
            };
            
            Plotly.newPlot('health-chart', [trace], layout, {responsive: true});
        }
        
        // Функція для оновлення аналізу економічного здоров'я
        function updateHealthAnalysis(analysis, methodology) {
            const analysisDiv = document.getElementById('health-analysis');
            
            if (!analysis || Object.keys(analysis).length === 0) {
                analysisDiv.innerHTML = '<div class="alert alert-warning">Немає даних для аналізу</div>';
                return;
            }
            
            let html = '<div class="row">';
            
            // Сортуємо країни за балом
            const sortedCountries = Object.keys(analysis).sort((a, b) => analysis[b].health_score - analysis[a].health_score);
            
            sortedCountries.forEach(countryCode => {
                const country = analysis[countryCode];
                const levelClass = getHealthLevelClass(country.health_level);
                
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">${country.country_name}</h6>
                                <span class="badge ${levelClass}">${country.health_level}</span>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <strong>Загальний бал:</strong> ${country.health_score}/100
                                </div>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar ${levelClass.replace('bg-', 'bg-')}" 
                                         style="width: ${country.health_score}%">
                                        ${country.health_score}%
                                    </div>
                                </div>
                                <div class="small">
                `;
                
                // Показники
                Object.entries(country.indicators).forEach(([indicator, data]) => {
                    html += `
                        <div class="d-flex justify-content-between">
                            <span>${getIndicatorName(indicator)}:</span>
                            <span>${data.value.toFixed(2)} (${data.score}/100)</span>
                        </div>
                    `;
                });
                
                html += `
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Додаємо методологію
            html += `
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">Методологія оцінки</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
            `;
            
            Object.entries(methodology).forEach(([indicator, description]) => {
                html += `
                    <div class="col-md-6 mb-2">
                        <strong>${getIndicatorName(indicator)}:</strong> ${description}
                    </div>
                `;
            });
            
            html += '</div></div></div>';
            
            analysisDiv.innerHTML = html;
        }
        
        // Допоміжна функція для отримання класу CSS для рівня здоров'я
        function getHealthLevelClass(level) {
            switch(level) {
                case 'Excellent': return 'bg-success';
                case 'Good': return 'bg-info';
                case 'Medium': return 'bg-warning';
                case 'Poor': return 'bg-danger';
                case 'Critical': return 'bg-dark';
                case 'No Data': return 'bg-secondary';
                default: return 'bg-secondary';
            }
        }
        
        // Функції для відображення статусу даних (глобальний)
        function showDataStatus(type, status, details = '') {
            const alert = document.getElementById('data-status-alert');
            const statusText = document.getElementById('data-status-text');
            const statusDetails = document.getElementById('data-status-details');
            
            // Видаляємо попередні класи
            alert.className = 'alert d-flex align-items-center';
            
            // Додаємо відповідний клас та іконку
            switch(type) {
                case 'success':
                    alert.classList.add('alert-success');
                    alert.querySelector('i').className = 'fas fa-check-circle me-2';
                    break;
                case 'warning':
                    alert.classList.add('alert-warning');
                    alert.querySelector('i').className = 'fas fa-exclamation-triangle me-2';
                    break;
                case 'error':
                    alert.classList.add('alert-danger');
                    alert.querySelector('i').className = 'fas fa-exclamation-circle me-2';
                    break;
                case 'info':
                default:
                    alert.classList.add('alert-info');
                    alert.querySelector('i').className = 'fas fa-info-circle me-2';
                    break;
            }
            
            statusText.textContent = status;
            statusDetails.textContent = details;
            alert.style.display = 'flex';
            
            // Автоматично приховуємо через 5 секунд для успішних статусів
            if (type === 'success') {
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 5000);
            }
        }
        
        function hideDataStatus() {
            document.getElementById('data-status-alert').style.display = 'none';
        }
        
        // Функції для відображення статусу у панелі Світового банку
        function showWorldBankStatus(type, status, details = '', tabId = null) {
            // Загальний API статус (тільки для реальних операцій, не для підказок)
            if (type !== 'info' || (status !== 'Натисніть "Завантажити"' && 
                                   status !== 'Натисніть "Порівняти"' && 
                                   status !== 'Натисніть "Аналізувати"' && 
                                   status !== 'Натисніть "Нормалізувати дані"' && 
                                   status !== 'Натисніть "Аналізувати здоров\'я"')) {
                
                const apiAlert = document.getElementById('worldbank-api-status-alert');
                const apiStatusText = document.getElementById('worldbank-api-status-text');
                const apiStatusDetails = document.getElementById('worldbank-api-status-details');

                apiAlert.className = 'alert d-flex align-items-center mb-3';

                switch(type) {
                    case 'success':
                        apiAlert.classList.add('alert-success');
                        apiAlert.querySelector('i').className = 'fas fa-check-circle me-2';
                        break;
                    case 'warning':
                        apiAlert.classList.add('alert-warning');
                        apiAlert.querySelector('i').className = 'fas fa-exclamation-triangle me-2';
                        break;
                    case 'error':
                        apiAlert.classList.add('alert-danger');
                        apiAlert.querySelector('i').className = 'fas fa-exclamation-circle me-2';
                        break;
                    case 'info':
                    default:
                        apiAlert.classList.add('alert-info');
                        apiAlert.querySelector('i').className = 'fas fa-info-circle me-2';
                        break;
                }

                apiStatusText.textContent = status;
                apiStatusDetails.textContent = details;
                apiAlert.style.display = 'flex';

                if (type === 'success') {
                    setTimeout(() => {
                        apiAlert.style.display = 'none';
                    }, 5000);
                }
            }

            // Статус для конкретної вкладки
            if (tabId) {
                const tabAlert = document.getElementById(`${tabId}-status-alert`);
                const tabStatusText = document.getElementById(`${tabId}-status-text`);
                const tabStatusDetails = document.getElementById(`${tabId}-status-details`);
                
                if (tabAlert && tabStatusText && tabStatusDetails) {
                    tabAlert.className = 'alert d-flex align-items-center mb-3';
                    
                    switch(type) {
                        case 'success':
                            tabAlert.classList.add('alert-success');
                            tabAlert.querySelector('i').className = 'fas fa-check-circle me-2';
                            break;
                        case 'warning':
                            tabAlert.classList.add('alert-warning');
                            tabAlert.querySelector('i').className = 'fas fa-exclamation-triangle me-2';
                            break;
                        case 'error':
                            tabAlert.classList.add('alert-danger');
                            tabAlert.querySelector('i').className = 'fas fa-exclamation-circle me-2';
                            break;
                        case 'info':
                        default:
                            tabAlert.classList.add('alert-light');
                            tabAlert.querySelector('i').className = 'fas fa-info-circle me-2';
                            break;
                    }
                    
                    tabStatusText.textContent = status;
                    tabStatusDetails.textContent = details;
                    tabAlert.style.display = 'flex';
                }
            }
        }

        function hideWorldBankStatus() {
            document.getElementById('worldbank-api-status-alert').style.display = 'none';
        }

        // Показуємо підказки для всіх вкладок при завантаженні
        function showTabHints() {
            // Показники
            showTabStatus('indicators', 'info', 'Натисніть "Завантажити"', 'Оберіть країни, показники та період');
            
            // Порівняння
            showTabStatus('comparison', 'info', 'Натисніть "Порівняти"', 'Оберіть показник, країни та років для аналізу');
            
            // Тренди
            showTabStatus('trends', 'info', 'Натисніть "Аналізувати"', 'Оберіть країну, показники та років для аналізу');
            
            // Нормалізовані
            showTabStatus('normalized', 'info', 'Натисніть "Нормалізувати дані"', 'Оберіть країни, показники, валюту та період');
            
            // Економічне здоров'я
            showTabStatus('health', 'info', 'Натисніть "Аналізувати здоров\'я"', 'Оберіть країни та період для аналізу економічного здоров\'я');
        }

        // Перевіряємо стан API при завантаженні сторінки
        async function checkAPIStatus() {
            try {
                // Показуємо статус перевірки
                showWorldBankStatus('info', 'Перевірка API...', 'Тестуємо підключення до Світового банку');
                
                // Робимо тестовий запит до API
                const response = await fetch('/api/worldbank/indicators?countries=UA&indicators=GDP&start_year=2023&end_year=2023');
                const result = await response.json();
                
                // Перевіряємо чи отримали реальні дані
                if (result && result.data && result.data.length > 0) {
                    const firstItem = result.data[0];
                    // Якщо це зразкові дані (Ukraine з певними значеннями)
                    if (firstItem.Country_Name === 'Ukraine' && firstItem.GDP === 200) {
                        showWorldBankStatus('warning', 'API недоступний', 'Використовуються зразкові дані для демонстрації');
                    } else {
                        showWorldBankStatus('success', 'API працює', 'Підключення до Світового банку успішне');
                    }
                } else {
                    showWorldBankStatus('warning', 'API недоступний', 'Не вдалося отримати дані з Світового банку');
                }
                
            } catch (error) {
                console.error('Помилка перевірки API:', error);
                showWorldBankStatus('error', 'API недоступний', 'Не вдалося підключитися до Світового банку');
            }
        }

        // Функція для показу статусу конкретної вкладки
        function showTabStatus(tabId, type, status, details) {
            const tabAlert = document.getElementById(`${tabId}-status-alert`);
            const tabStatusText = document.getElementById(`${tabId}-status-text`);
            const tabStatusDetails = document.getElementById(`${tabId}-status-details`);
            
            if (tabAlert && tabStatusText && tabStatusDetails) {
                tabAlert.className = 'alert d-flex align-items-center mb-3';
                tabAlert.classList.add('alert-light');
                tabAlert.querySelector('i').className = 'fas fa-info-circle me-2';
                
                tabStatusText.textContent = status;
                tabStatusDetails.textContent = details;
                tabAlert.style.display = 'flex';
            }
        }

        // Перевірка статусу даних Світового банку
        async function checkWorldBankDataStatus() {
            try {
                const response = await fetch('/api/worldbank/indicators?start_year=2020&end_year=2023');
                const payload = await response.json();
                const rows = (payload && payload.data) ? payload.data : payload;
                
                // Перевіряємо чи дані виглядають як зразкові
                if (rows && rows.length > 0) {
                    const firstItem = rows[0];
                    // Зразкові дані мають певні характеристики (GDP = 200 для України)
                    if (firstItem.Country_Name === 'Ukraine' && firstItem.GDP === 200) {
                        showWorldBankStatus('warning', 
                            'Використовуються зразкові дані', 
                            'API Світового банку недоступний. Відображаються демонстраційні дані для тестування функціональності.');
                    } else {
                        showWorldBankStatus('success', 
                            'Дані з API Світового банку', 
                            'Отримано реальні економічні дані з офіційного джерела.');
                    }
                } else {
                    showWorldBankStatus('error', 
                        'Дані недоступні', 
                        'Не вдалося завантажити дані з API Світового банку.');
                }
            } catch (error) {
                showWorldBankStatus('error', 
                    'Помилка завантаження', 
                    'Не вдалося перевірити статус даних: ' + error.message);
            }
        }

        // API Моніторинг функції
        let apiLogsEnabled = true;
        let apiStats = {
            total: 0,
            success: 0,
            error: 0,
            cached: 0
        };

        function logApiRequest(method, url, params, startTime) {
            if (!apiLogsEnabled) return;
            
            apiStats.total++;
            updateApiStats();
            
            const logEntry = document.createElement('div');
            logEntry.className = 'api-log-entry mb-3 p-3 border rounded';
            logEntry.style.backgroundColor = '#ffffff';
            
            const timestamp = new Date().toLocaleTimeString();
            const requestId = Math.random().toString(36).substr(2, 9);
            
            logEntry.innerHTML = `
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <span class="badge bg-primary me-2">${method}</span>
                        <strong>${url}</strong>
                        <small class="text-muted ms-2">[${requestId}]</small>
                    </div>
                    <small class="text-muted">${timestamp}</small>
                </div>
                <div class="mb-2">
                    <strong>Параметри:</strong>
                    <pre class="mb-1 mt-1" style="font-size: 0.8rem; background-color: #f8f9fa; padding: 0.5rem; border-radius: 0.25rem;">${JSON.stringify(params, null, 2)}</pre>
                </div>
                <div class="api-response-${requestId}">
                    <div class="text-muted">
                        <i class="fas fa-spinner fa-spin me-1"></i>
                        Очікування відповіді...
                    </div>
                </div>
            `;
            
            const logsContainer = document.getElementById('api-logs');
            if (logsContainer.children.length === 1 && logsContainer.children[0].classList.contains('text-muted')) {
                logsContainer.innerHTML = '';
            }
            logsContainer.appendChild(logEntry);
            
            // Автоскрол до останнього запису
            logsContainer.scrollTop = logsContainer.scrollHeight;
            
            return requestId;
        }

        function logApiResponse(requestId, response, error = null, responseTime = null) {
            if (!apiLogsEnabled) return;
            
            const responseElement = document.querySelector(`.api-response-${requestId}`);
            if (!responseElement) return;
            
            if (error) {
                apiStats.error++;
                responseElement.innerHTML = `
                    <div class="text-danger">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <strong>Помилка:</strong> ${error.message || error}
                        ${responseTime ? `<small class="ms-2">(${responseTime}ms)</small>` : ''}
                    </div>
                `;
            } else {
                apiStats.success++;
                const statusCode = response.status || 200;
                const statusClass = statusCode >= 200 && statusCode < 300 ? 'text-success' : 'text-danger';
                
                responseElement.innerHTML = `
                    <div class="${statusClass}">
                        <i class="fas fa-check-circle me-1"></i>
                        <strong>Відповідь:</strong> ${statusCode}
                        ${responseTime ? `<small class="ms-2">(${responseTime}ms)</small>` : ''}
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="toggleResponseDetails('${requestId}')">
                            <i class="fas fa-eye me-1"></i>
                            Деталі
                        </button>
                    </div>
                    <div class="api-response-details-${requestId}" style="display: none; margin-top: 0.5rem;">
                        <pre style="font-size: 0.8rem; background-color: #f8f9fa; padding: 0.5rem; border-radius: 0.25rem; max-height: 200px; overflow-y: auto;">${JSON.stringify(response, null, 2)}</pre>
                    </div>
                `;
            }
            
            updateApiStats();
        }

        function logApiCached(requestId, cacheKey) {
            if (!apiLogsEnabled) return;
            
            apiStats.cached++;
            updateApiStats();
            
            const responseElement = document.querySelector(`.api-response-${requestId}`);
            if (!responseElement) return;
            
            responseElement.innerHTML = `
                <div class="text-info">
                    <i class="fas fa-database me-1"></i>
                    <strong>З кешу:</strong> ${cacheKey}
                    <small class="ms-2">(0ms)</small>
                </div>
            `;
        }

        function toggleResponseDetails(requestId) {
            const detailsElement = document.querySelector(`.api-response-details-${requestId}`);
            if (detailsElement) {
                detailsElement.style.display = detailsElement.style.display === 'none' ? 'block' : 'none';
            }
        }

        function updateApiStats() {
            document.getElementById('api-total-requests').textContent = apiStats.total;
            document.getElementById('api-success-requests').textContent = apiStats.success;
            document.getElementById('api-error-requests').textContent = apiStats.error;
            document.getElementById('api-cached-requests').textContent = apiStats.cached;
        }

        function clearApiLogs() {
            document.getElementById('api-logs').innerHTML = `
                <div class="text-muted text-center">
                    <i class="fas fa-info-circle me-2"></i>
                    Логи API запитів з'являться тут...
                </div>
            `;
            apiStats = { total: 0, success: 0, error: 0, cached: 0 };
            updateApiStats();
        }

        function toggleApiLogs() {
            apiLogsEnabled = !apiLogsEnabled;
            const toggleIcon = document.getElementById('toggle-icon');
            const toggleText = document.getElementById('toggle-text');
            
            if (apiLogsEnabled) {
                toggleIcon.className = 'fas fa-pause me-1';
                toggleText.textContent = 'Пауза';
            } else {
                toggleIcon.className = 'fas fa-play me-1';
                toggleText.textContent = 'Продовжити';
            }
        }

        function showServerLogs() {
            const logsContainer = document.getElementById('api-logs');
            
            // Створюємо модальне вікно для серверних логів
            const modalHtml = `
                <div class="modal fade" id="serverLogsModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-server me-2"></i>
                                    Серверні логи World Bank API
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Ці логи показують зовнішні запити до World Bank API та їх відповіді.
                                    Переглядайте консоль сервера для повних логів.
                                </div>
                                <div id="server-logs-content" style="height: 500px; overflow-y: auto; background-color: #f8f9fa; padding: 1rem; border-radius: 0.375rem; font-family: monospace; font-size: 0.9rem;">
                                    <div class="text-muted">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Серверні логи з'являться тут...
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрити</button>
                                <button type="button" class="btn btn-primary" onclick="refreshServerLogs()">Оновити</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Видаляємо попереднє модальне вікно якщо воно існує
            const existingModal = document.getElementById('serverLogsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Додаємо нове модальне вікно
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Показуємо модальне вікно
            const modal = new bootstrap.Modal(document.getElementById('serverLogsModal'));
            modal.show();
            
            // Завантажуємо серверні логи
            refreshServerLogs();
        }

        function refreshServerLogs() {
            const logsContent = document.getElementById('server-logs-content');
            if (!logsContent) return;
            
            logsContent.innerHTML = `
                <div class="text-muted text-center">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    Завантаження серверних логів...
                </div>
            `;
            
            // Завантажуємо реальні серверні логи
            fetch('/api/server-logs')
                .then(response => response.json())
                .then(data => {
                    if (data.logs && data.logs.length > 0) {
                        let logsHtml = '';
                        data.logs.slice(-20).reverse().forEach(log => {
                            const timestamp = new Date(log.timestamp).toLocaleTimeString();
                            let typeClass = 'text-info';
                            let iconClass = 'fas fa-info-circle';
                            
                            // Визначаємо стиль залежно від типу логу
                            if (log.type.includes('worldbank_request')) {
                                typeClass = 'text-primary';
                                iconClass = 'fas fa-globe';
                            } else if (log.type.includes('worldbank_indicator_request')) {
                                typeClass = 'text-primary';
                                iconClass = 'fas fa-chart-line';
                            } else if (log.type.includes('worldbank_indicator_success')) {
                                typeClass = 'text-success';
                                iconClass = 'fas fa-check-circle';
                            } else if (log.type.includes('worldbank_indicator_error') || log.type.includes('worldbank_trends_error')) {
                                typeClass = 'text-danger';
                                iconClass = 'fas fa-exclamation-triangle';
                            } else if (log.type.includes('worldbank_indicator_no_data') || log.type.includes('worldbank_trends_no_data')) {
                                typeClass = 'text-warning';
                                iconClass = 'fas fa-exclamation-circle';
                            } else if (log.type.includes('worldbank_comparison')) {
                                typeClass = 'text-info';
                                iconClass = 'fas fa-balance-scale';
                            } else if (log.type.includes('worldbank_trends')) {
                                typeClass = 'text-info';
                                iconClass = 'fas fa-trending-up';
                            }
                            
                            logsHtml += `
                                <div class="mb-3 p-3 border rounded">
                                    <div class="${typeClass}">
                                        <i class="${iconClass} me-2"></i>
                                        <strong>[${timestamp}] ${log.message}</strong>
                                    </div>
                                    <div class="ms-3 mt-2">
                                        ${log.details && Object.keys(log.details).length > 0 ? `
                                            ${log.details.url ? `
                                                <div class="mb-2">
                                                    <strong>URL:</strong><br>
                                                    <code style="font-size: 0.8rem; word-break: break-all; background-color: #f8f9fa; padding: 0.25rem; border-radius: 0.25rem;">${log.details.url}</code>
                                                </div>
                                            ` : ''}
                                            ${log.details.countries ? `
                                                <div class="mb-2">
                                                    <strong>Країни:</strong> ${Array.isArray(log.details.countries) ? log.details.countries.join(', ') : log.details.countries}
                                                </div>
                                            ` : ''}
                                            ${log.details.indicator ? `
                                                <div class="mb-2">
                                                    <strong>Показник:</strong> ${log.details.indicator}
                                                </div>
                                            ` : ''}
                                            ${log.details.indicators ? `
                                                <div class="mb-2">
                                                    <strong>Показники:</strong> ${Array.isArray(log.details.indicators) ? log.details.indicators.join(', ') : log.details.indicators}
                                                </div>
                                            ` : ''}
                                            ${log.details.years ? `
                                                <div class="mb-2">
                                                    <strong>Роки:</strong> ${Array.isArray(log.details.years) ? log.details.years.join(', ') : log.details.years}
                                                </div>
                                            ` : ''}
                                            ${log.details.records_count ? `
                                                <div class="mb-2">
                                                    <strong>Записів отримано:</strong> ${log.details.records_count}
                                                </div>
                                            ` : ''}
                                            ${log.details.error ? `
                                                <div class="mb-2">
                                                    <strong>Помилка:</strong><br>
                                                    <span class="text-danger">${log.details.error}</span>
                                                </div>
                                            ` : ''}
                                            ${log.details.date_range ? `
                                                <div class="mb-2">
                                                    <strong>Діапазон дат:</strong> ${log.details.date_range}
                                                </div>
                                            ` : ''}
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        });
                        logsContent.innerHTML = logsHtml || '<div class="text-muted">Немає логів</div>';
                    } else {
                        logsContent.innerHTML = '<div class="text-muted">Немає логів</div>';
                    }
                })
                .catch(error => {
                    logsContent.innerHTML = `
                        <div class="text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Помилка завантаження логів: ${error.message}
                        </div>
                    `;
                });
        }

        function clearCache() {
            if (confirm('Ви впевнені, що хочете очистити кеш World Bank API? Це призведе до нових запитів до зовнішнього API.')) {
                fetch('/api/clear-cache', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        alert('Кеш очищено успішно!');
                        // Оновлюємо серверні логи після очищення кешу
                        refreshServerLogs();
                    })
                    .catch(error => {
                        alert('Помилка очищення кешу: ' + error.message);
                    });
            }
        }

        // Перехоплення fetch запитів для логування
        const originalFetch = window.fetch;
        window.fetch = function(url, options = {}) {
            if (url.includes('/api/worldbank/')) {
                const startTime = Date.now();
                const method = options.method || 'GET';
                const params = new URLSearchParams(url.split('?')[1] || '');
                
                const requestId = logApiRequest(method, url, Object.fromEntries(params), startTime);
                
                return originalFetch(url, options)
                    .then(response => {
                        const responseTime = Date.now() - startTime;
                        
                        if (response.ok) {
                            return response.clone().json()
                                .then(data => {
                                    logApiResponse(requestId, data, null, responseTime);
                                    return response;
                                })
                                .catch(() => {
                                    logApiResponse(requestId, { status: response.status }, null, responseTime);
                                    return response;
                                });
                        } else {
                            logApiResponse(requestId, { status: response.status }, new Error(`HTTP ${response.status}`), responseTime);
                            return response;
                        }
                    })
                    .catch(error => {
                        const responseTime = Date.now() - startTime;
                        logApiResponse(requestId, null, error, responseTime);
                        throw error;
                    });
            }
            
            return originalFetch(url, options);
        };
    </script>
</body>
</html>
