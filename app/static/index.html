<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Економетричний Дашборд - Торгівельно-виробниче підприємство</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar-brand {
            font-weight: bold;
            color: #2c3e50 !important;
        }
        
        .kpi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .kpi-card:hover {
            transform: translateY(-5px);
        }
        
        .kpi-card.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .kpi-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .kpi-card.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .kpi-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .kpi-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            color: #2c3e50;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .filter-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .btn-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            color: white;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <!-- Навігаційна панель -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i>
                Економетричний Дашборд
            </a>
            <div class="navbar-nav ms-auto">
                <button class="btn btn-custom" onclick="regenerateData()">
                    <i class="fas fa-sync-alt me-2"></i>
                    Оновити дані
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- KPI Панель -->
        <div class="row" id="kpi-panel">
            <div class="col-md-3">
                <div class="kpi-card success">
                    <div class="kpi-value" id="total-revenue">₴0</div>
                    <div class="kpi-label">
                        <i class="fas fa-money-bill-wave me-2"></i>
                        Загальна виручка
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card warning">
                    <div class="kpi-value" id="total-profit">₴0</div>
                    <div class="kpi-label">
                        <i class="fas fa-chart-pie me-2"></i>
                        Загальний прибуток
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card info">
                    <div class="kpi-value" id="total-sales">0</div>
                    <div class="kpi-label">
                        <i class="fas fa-shopping-cart me-2"></i>
                        Кількість продажів
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-value" id="profit-margin">0%</div>
                    <div class="kpi-label">
                        <i class="fas fa-percentage me-2"></i>
                        Середня маржа
                    </div>
                </div>
            </div>
        </div>

        <!-- Фільтри -->
        <div class="filter-section">
            <h5 class="mb-3">
                <i class="fas fa-filter me-2"></i>
                Фільтри даних
            </h5>
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Початкова дата</label>
                    <input type="date" class="form-control" id="start-date">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Кінцева дата</label>
                    <input type="date" class="form-control" id="end-date">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Категорія</label>
                    <select class="form-select" id="category-filter">
                        <option value="">Всі категорії</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Регіон</label>
                    <select class="form-select" id="region-filter">
                        <option value="">Всі регіони</option>
                    </select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-12">
                    <button class="btn btn-custom" onclick="applyFilters()">
                        <i class="fas fa-search me-2"></i>
                        Застосувати фільтри
                    </button>
                    <button class="btn btn-outline-secondary ms-2" onclick="clearFilters()">
                        <i class="fas fa-times me-2"></i>
                        Очистити
                    </button>
                </div>
            </div>
        </div>

        <!-- Панель перегляду файлів -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="chart-container">
                    <div class="chart-title">
                        <i class="fas fa-database me-2"></i>
                        Перегляд файлів даних
                        <button class="btn btn-sm btn-outline-success ms-2" onclick="loadFilesList()" title="Оновити список файлів">
                            <i class="fas fa-sync-alt"></i> Оновити
                        </button>
                    </div>
                    <div id="files-panel">
                        <div class="row">
                            <div class="col-md-4">
                                <h6>Файли даних</h6>
                                <div id="files-list" class="list-group">
                                    <!-- Список файлів буде завантажений тут -->
                                </div>
                            </div>
                            <div class="col-md-8">
                                <h6>Вміст файлу</h6>
                                <div id="file-content">
                                    <p class="text-muted">Оберіть файл для перегляду</p>
                                </div>
                                <div id="file-pagination" class="mt-3">
                                    <!-- Пагінація буде тут -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Панель даних Світового банку -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="chart-container">
                    <div class="chart-title">
                        <i class="fas fa-globe me-2"></i>
                        Економетричні дані Світового банку
                    </div>
                    <div id="worldbank-panel">
                        <!-- Фільтри для даних Світового банку -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label class="form-label">Країни</label>
                                <select id="worldbank-countries" class="form-select" multiple>
                                    <!-- Буде заповнено динамічно -->
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Показники</label>
                                <select id="worldbank-indicators" class="form-select" multiple>
                                    <!-- Буде заповнено динамічно -->
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Початковий рік</label>
                                <input type="number" id="worldbank-start-year" class="form-control" value="2020" min="1960" max="2024">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Кінцевий рік</label>
                                <input type="number" id="worldbank-end-year" class="form-control" value="2023" min="1960" max="2024">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <div>
                                    <button class="btn btn-custom w-100" onclick="loadWorldBankData()">
                                        <i class="fas fa-download me-1"></i>
                                        Завантажити
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Навігація по розділах -->
                        <ul class="nav nav-tabs" id="worldbank-tabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="indicators-tab" data-bs-toggle="tab" data-bs-target="#indicators-content" type="button" role="tab">
                                    <i class="fas fa-chart-line me-1"></i>
                                    Показники
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="normalized-tab" data-bs-toggle="tab" data-bs-target="#normalized-content" type="button" role="tab">
                                    <i class="fas fa-calculator me-1"></i>
                                    Нормалізовані
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="health-tab" data-bs-toggle="tab" data-bs-target="#health-content" type="button" role="tab">
                                    <i class="fas fa-heartbeat me-1"></i>
                                    Економічне здоров'я
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="comparison-tab" data-bs-toggle="tab" data-bs-target="#comparison-content" type="button" role="tab">
                                    <i class="fas fa-balance-scale me-1"></i>
                                    Порівняння
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="trends-tab" data-bs-toggle="tab" data-bs-target="#trends-content" type="button" role="tab">
                                    <i class="fas fa-trending-up me-1"></i>
                                    Тренди
                                </button>
                            </li>
                        </ul>

                        <!-- Вміст вкладок -->
                        <div class="tab-content" id="worldbank-tab-content">
                            <!-- Вкладка показників -->
                            <div class="tab-pane fade show active" id="indicators-content" role="tabpanel">
                                <div class="row mt-3">
                                    <div class="col-md-12">
                                        <div id="worldbank-indicators-chart" style="height: 500px;"></div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-12">
                                        <div class="table-responsive">
                                            <table id="worldbank-indicators-table" class="table table-striped">
                                                <thead>
                                                    <tr>
                                                        <th>Країна</th>
                                                        <th>Рік</th>
                                                        <th>ВВП</th>
                                                        <th>ВВП на душу</th>
                                                        <th>Інфляція</th>
                                                        <th>Безробіття</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- Дані будуть завантажені тут -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Вкладка порівняння -->
                            <div class="tab-pane fade" id="comparison-content" role="tabpanel">
                                <div class="row mt-3">
                                    <div class="col-md-8">
                                        <div id="worldbank-comparison-chart" style="height: 400px;"></div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">Налаштування порівняння</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Показник</label>
                                                    <select id="comparison-indicator" class="form-select">
                                                        <option value="GDP_PER_CAPITA">ВВП на душу населення</option>
                                                        <option value="GDP">ВВП</option>
                                                        <option value="INFLATION">Інфляція</option>
                                                        <option value="UNEMPLOYMENT">Безробіття</option>
                                                        <option value="LIFE_EXPECTANCY">Тривалість життя</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Країни для порівняння</label>
                                                    <input type="text" id="comparison-countries" class="form-control" placeholder="UA,US,DE,PL" value="UA,US,DE,PL">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Років для аналізу</label>
                                                    <input type="number" id="comparison-years" class="form-control" value="10" min="5" max="30">
                                                </div>
                                                <button class="btn btn-custom w-100" onclick="loadComparisonData()">
                                                    <i class="fas fa-chart-bar me-1"></i>
                                                    Порівняти
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Вкладка трендів -->
                            <div class="tab-pane fade" id="trends-content" role="tabpanel">
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">Аналіз трендів</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Країна</label>
                                                    <select id="trends-country" class="form-select">
                                                        <option value="UA">Україна</option>
                                                        <option value="US">США</option>
                                                        <option value="DE">Німеччина</option>
                                                        <option value="PL">Польща</option>
                                                        <option value="CN">Китай</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Показники</label>
                                                    <select id="trends-indicators" class="form-select" multiple>
                                                        <option value="GDP">ВВП</option>
                                                        <option value="GDP_PER_CAPITA">ВВП на душу</option>
                                                        <option value="INFLATION">Інфляція</option>
                                                        <option value="UNEMPLOYMENT">Безробіття</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Років для аналізу</label>
                                                    <input type="number" id="trends-years" class="form-control" value="20" min="5" max="50">
                                                </div>
                                                <button class="btn btn-custom w-100" onclick="loadTrendsData()">
                                                    <i class="fas fa-trending-up me-1"></i>
                                                    Аналізувати
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div id="worldbank-trends-chart" style="height: 500px;"></div>
                                        <div id="trends-analysis" class="mt-3">
                                            <!-- Результати аналізу будуть тут -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Вкладка нормалізованих даних -->
                            <div class="tab-pane fade" id="normalized-content" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-calculator me-2"></i>
                                                    Нормалізація даних
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Країни</label>
                                                    <select id="normalized-countries" class="form-select" multiple>
                                                        <option value="UA">Україна</option>
                                                        <option value="US">США</option>
                                                        <option value="DE">Німеччина</option>
                                                        <option value="PL">Польща</option>
                                                        <option value="FR">Франція</option>
                                                        <option value="GB">Великобританія</option>
                                                        <option value="CN">Китай</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Показники</label>
                                                    <select id="normalized-indicators" class="form-select" multiple>
                                                        <option value="GDP">ВВП</option>
                                                        <option value="GDP_PER_CAPITA">ВВП на душу</option>
                                                        <option value="INFLATION">Інфляція</option>
                                                        <option value="UNEMPLOYMENT">Безробіття</option>
                                                        <option value="EXPORTS">Експорт</option>
                                                        <option value="IMPORTS">Імпорт</option>
                                                        <option value="POPULATION">Населення</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Валюта</label>
                                                    <select id="normalized-currency" class="form-select">
                                                        <option value="USD">Долар США</option>
                                                        <option value="EUR">Євро</option>
                                                        <option value="UAH">Гривня</option>
                                                        <option value="PLN">Злотий</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Початковий рік</label>
                                                    <input type="number" id="normalized-start-year" class="form-control" value="2020" min="2000" max="2023">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Кінцевий рік</label>
                                                    <input type="number" id="normalized-end-year" class="form-control" value="2023" min="2000" max="2023">
                                                </div>
                                                <button class="btn btn-custom w-100" onclick="loadNormalizedData()">
                                                    <i class="fas fa-calculator me-1"></i>
                                                    Нормалізувати дані
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div id="normalized-chart" style="height: 500px;"></div>
                                        <div id="normalized-table" class="mt-3">
                                            <!-- Таблиця нормалізованих даних -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Вкладка аналізу економічного здоров'я -->
                            <div class="tab-pane fade" id="health-content" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-heartbeat me-2"></i>
                                                    Аналіз економічного здоров'я
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Країни для аналізу</label>
                                                    <select id="health-countries" class="form-select" multiple>
                                                        <option value="UA">Україна</option>
                                                        <option value="US">США</option>
                                                        <option value="DE">Німеччина</option>
                                                        <option value="PL">Польща</option>
                                                        <option value="FR">Франція</option>
                                                        <option value="GB">Великобританія</option>
                                                        <option value="CN">Китай</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Початковий рік</label>
                                                    <input type="number" id="health-start-year" class="form-control" value="2020" min="2000" max="2023">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Кінцевий рік</label>
                                                    <input type="number" id="health-end-year" class="form-control" value="2023" min="2000" max="2023">
                                                </div>
                                                <button class="btn btn-custom w-100" onclick="loadEconomicHealth()">
                                                    <i class="fas fa-heartbeat me-1"></i>
                                                    Аналізувати здоров'я
                                                </button>
                                                <div class="mt-3">
                                                    <small class="text-muted">
                                                        <strong>Методологія:</strong><br>
                                                        • ВВП на душу: 30%<br>
                                                        • Інфляція: 25%<br>
                                                        • Безробіття: 25%<br>
                                                        • Тривалість життя: 20%
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div id="health-chart" style="height: 500px;"></div>
                                        <div id="health-analysis" class="mt-3">
                                            <!-- Результати аналізу економічного здоров'я -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Графіки -->
        <div class="row">
            <!-- Графік продажів у часі -->
            <div class="col-md-6">
                <div class="chart-container">
                    <div class="chart-title">
                        <i class="fas fa-chart-line me-2"></i>
                        Динаміка продажів
                    </div>
                    <div id="sales-chart" style="height: 400px;"></div>
                </div>
            </div>
            
            <!-- Графік продажів за продуктами -->
            <div class="col-md-6">
                <div class="chart-container">
                    <div class="chart-title">
                        <i class="fas fa-chart-bar me-2"></i>
                        Топ продуктів
                    </div>
                    <div id="products-chart" style="height: 400px;"></div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Графік продажів за регіонами -->
            <div class="col-md-6">
                <div class="chart-container">
                    <div class="chart-title">
                        <i class="fas fa-chart-pie me-2"></i>
                        Розподіл за регіонами
                    </div>
                    <div id="regions-chart" style="height: 400px;"></div>
                </div>
            </div>
            
            <!-- Графік рентабельності -->
            <div class="col-md-6">
                <div class="chart-container">
                    <div class="chart-title">
                        <i class="fas fa-chart-area me-2"></i>
                        Рентабельність продуктів
                    </div>
                    <div id="profitability-chart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Глобальні змінні
        let currentData = {
            sales: [],
            trends: [],
            profit: [],
            stats: {}
        };

        // Ініціалізація сторінки
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM завантажено');
            loadInitialData();
            setupDateFilters();
            initializeWorldBankData(); // Додаємо ініціалізацію даних Світового банку
            
            // Завантажуємо файли безпосередньо
            console.log('Запуск завантаження файлів...');
            window.loadFilesList = loadFilesList;
            window.loadFileContent = loadFileContent;
            window.showFileStats = showFileStats;
            window.applyFilters = applyFilters;
            window.clearFilters = clearFilters;
            window.regenerateData = regenerateData;
            
            window.loadWorldBankData = loadWorldBankData;
            window.loadComparisonData = loadComparisonData;
            window.loadTrendsData = loadTrendsData;
            window.loadNormalizedData = loadNormalizedData;
            window.loadEconomicHealth = loadEconomicHealth;

            loadFilesList();
        });

        // Завантаження початкових даних
        async function loadInitialData() {
            try {
                showLoading();
                
                // Завантажуємо всі дані паралельно
                const [salesRes, trendsRes, profitRes, statsRes, categoriesRes, regionsRes] = await Promise.all([
                    fetch('/api/sales?limit=5000'),
                    fetch('/api/trends'),
                    fetch('/api/profit'),
                    fetch('/api/stats'),
                    fetch('/api/categories'),
                    fetch('/api/regions')
                ]);

                currentData.sales = await salesRes.json();
                currentData.trends = await trendsRes.json();
                currentData.profit = await profitRes.json();
                currentData.stats = await statsRes.json();

                // Заповнюємо фільтри
                const categories = await categoriesRes.json();
                const regions = await regionsRes.json();
                
                populateSelect('category-filter', categories.categories);
                populateSelect('region-filter', regions.regions);

                // Оновлюємо інтерфейс
                updateKPIPanel();
                updateCharts();
                
                hideLoading();
            } catch (error) {
                console.error('Помилка завантаження даних:', error);
                showError('Помилка завантаження даних: ' + error.message);
            }
        }

        // Заповнення select елементів
        function populateSelect(selectId, data) {
            const select = document.getElementById(selectId);
            if (data && Array.isArray(data)) {
                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item.charAt(0).toUpperCase() + item.slice(1);
                    select.appendChild(option);
                });
            }
        }

        // Налаштування фільтрів дат
        function setupDateFilters() {
            const today = new Date();
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
            
            document.getElementById('end-date').value = today.toISOString().split('T')[0];
            document.getElementById('start-date').value = lastMonth.toISOString().split('T')[0];
        }

        // Оновлення KPI панелі
        function updateKPIPanel() {
            const stats = currentData.stats;
            
            document.getElementById('total-revenue').textContent = formatCurrency(stats.total_revenue);
            document.getElementById('total-profit').textContent = formatCurrency(stats.total_profit);
            document.getElementById('total-sales').textContent = formatNumber(stats.total_sales);
            document.getElementById('profit-margin').textContent = formatPercentage(stats.avg_profit_margin);
        }

        // Оновлення всіх графіків
        function updateCharts() {
            updateSalesChart();
            updateProductsChart();
            updateRegionsChart();
            updateProfitabilityChart();
        }

        // Графік продажів у часі
        function updateSalesChart() {
            const trends = currentData.trends;
            
            if (!trends || trends.length === 0) {
                document.getElementById('sales-chart').innerHTML = '<p>Немає даних для відображення</p>';
                return;
            }
            
            const trace = {
                x: trends.map(t => t.date),
                y: trends.map(t => t.total_revenue),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Виручка',
                line: { color: '#667eea', width: 3 },
                marker: { size: 6 }
            };

            const layout = {
                title: '',
                xaxis: { title: 'Дата' },
                yaxis: { title: 'Виручка (₴)' },
                hovermode: 'closest',
                showlegend: false,
                margin: { t: 0, b: 50, l: 50, r: 20 }
            };

            Plotly.newPlot('sales-chart', [trace], layout, {responsive: true});
        }

        // Графік топ продуктів
        function updateProductsChart() {
            const sales = currentData.sales;
            
            if (!sales || sales.length === 0) {
                document.getElementById('products-chart').innerHTML = '<p>Немає даних для відображення</p>';
                return;
            }
            
            // Групуємо за продуктами
            const productRevenue = {};
            sales.forEach(sale => {
                productRevenue[sale.product_name] = (productRevenue[sale.product_name] || 0) + sale.total_revenue;
            });

            // Сортуємо та беремо топ-10
            const topProducts = Object.entries(productRevenue)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);

            const trace = {
                x: topProducts.map(([name]) => name.length > 20 ? name.substring(0, 20) + '...' : name),
                y: topProducts.map(([,revenue]) => revenue),
                type: 'bar',
                marker: { color: '#38ef7d' }
            };

            const layout = {
                title: '',
                xaxis: { title: 'Продукт' },
                yaxis: { title: 'Виручка (₴)' },
                margin: { t: 0, b: 100, l: 50, r: 20 }
            };

            Plotly.newPlot('products-chart', [trace], layout, {responsive: true});
        }

        // Графік продажів за регіонами
        function updateRegionsChart() {
            const sales = currentData.sales;
            
            // Групуємо за регіонами
            const regionRevenue = {};
            sales.forEach(sale => {
                regionRevenue[sale.region] = (regionRevenue[sale.region] || 0) + sale.total_revenue;
            });

            const trace = {
                labels: Object.keys(regionRevenue).map(r => r.charAt(0).toUpperCase() + r.slice(1)),
                values: Object.values(regionRevenue),
                type: 'pie',
                marker: {
                    colors: ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe']
                }
            };

            const layout = {
                title: '',
                margin: { t: 0, b: 50, l: 50, r: 50 }
            };

            Plotly.newPlot('regions-chart', [trace], layout, {responsive: true});
        }

        // Графік рентабельності
        function updateProfitabilityChart() {
            const profit = currentData.profit;
            
            // Сортуємо за рентабельністю
            const sortedProfit = profit.sort((a, b) => b.profit_percentage - a.profit_percentage).slice(0, 10);

            const trace = {
                x: sortedProfit.map(p => p.product_name.length > 15 ? p.product_name.substring(0, 15) + '...' : p.product_name),
                y: sortedProfit.map(p => p.profit_percentage),
                type: 'bar',
                marker: { color: '#f5576c' }
            };

            const layout = {
                title: '',
                xaxis: { title: 'Продукт' },
                yaxis: { title: 'Рентабельність (%)' },
                margin: { t: 0, b: 100, l: 50, r: 20 }
            };

            Plotly.newPlot('profitability-chart', [trace], layout, {responsive: true});
        }

        // Застосування фільтрів
        async function applyFilters() {
            try {
                showLoading();
                
                const params = new URLSearchParams();
                
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const category = document.getElementById('category-filter').value;
                const region = document.getElementById('region-filter').value;
                
                if (startDate) params.append('start_date', startDate);
                if (endDate) params.append('end_date', endDate);
                if (category) params.append('category', category);
                if (region) params.append('region', region);
                
                params.append('limit', '5000');
                
                const response = await fetch(`/api/sales?${params}`);
                currentData.sales = await response.json();
                
                // Оновлюємо статистику
                const statsResponse = await fetch('/api/stats');
                currentData.stats = await statsResponse.json();
                
                updateKPIPanel();
                updateCharts();
                
                hideLoading();
            } catch (error) {
                console.error('Помилка застосування фільтрів:', error);
                showError('Помилка застосування фільтрів: ' + error.message);
            }
        }

        // Очищення фільтрів
        function clearFilters() {
            document.getElementById('start-date').value = '';
            document.getElementById('end-date').value = '';
            document.getElementById('category-filter').value = '';
            document.getElementById('region-filter').value = '';
            
            loadInitialData();
        }

        // Регенерація даних
        async function regenerateData() {
            try {
                showLoading();
                
                const response = await fetch('/api/regenerate', { method: 'POST' });
                const result = await response.json();
                
                if (response.ok) {
                    await loadInitialData();
                    showSuccess('Дані успішно оновлено!');
                } else {
                    throw new Error(result.detail || 'Помилка регенерації даних');
                }
            } catch (error) {
                console.error('Помилка регенерації даних:', error);
                showError('Помилка регенерації даних: ' + error.message);
            }
        }

        // Допоміжні функції
        function formatCurrency(amount) {
            return new Intl.NumberFormat('uk-UA', {
                style: 'currency',
                currency: 'UAH',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function formatNumber(number) {
            return new Intl.NumberFormat('uk-UA').format(number);
        }

        function formatPercentage(percentage) {
            return percentage.toFixed(1) + '%';
        }

        function showLoading() {
            document.body.style.opacity = '0.7';
            document.body.style.pointerEvents = 'none';
        }

        function hideLoading() {
            document.body.style.opacity = '1';
            document.body.style.pointerEvents = 'auto';
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.container').firstChild);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'alert alert-success';
            successDiv.textContent = message;
            document.querySelector('.container').insertBefore(successDiv, document.querySelector('.container').firstChild);
            
            setTimeout(() => successDiv.remove(), 3000);
        }

        


        // Функція для отримання назви показника
        function getIndicatorName(indicator) {
            const names = {
                'GDP': 'ВВП',
                'GDP_PER_CAPITA': 'ВВП на душу',
                'INFLATION': 'Інфляція',
                'UNEMPLOYMENT': 'Безробіття',
                'EXPORTS': 'Експорт',
                'IMPORTS': 'Імпорт',
                'POPULATION': 'Населення',
                'LIFE_EXPECTANCY': 'Тривалість життя',
                'INTERNET_USERS': 'Користувачі інтернету',
                'EDUCATION_EXPENDITURE': 'Витрати на освіту'
            };
            return names[indicator] || indicator;
        }

        // Функції для роботи з файлами
        let currentFile = null;
        let currentOffset = 0;
        const pageSize = 50;

        async function loadFilesList() {
            try {
                console.log('Завантаження списку файлів...');
                const response = await fetch('/api/files');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('Отримані файли:', result);
                
                const filesList = document.getElementById('files-list');
                if (!filesList) {
                    console.error('Елемент files-list не знайдено!');
                    return;
                }
                
                filesList.innerHTML = '';
                
                if (result.files && Array.isArray(result.files)) {
                    console.log('Обробка файлів:', result.files.length);
                    result.files.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'list-group-item list-group-item-action';
                    fileItem.style.cursor = 'pointer';
                    fileItem.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${file.name}</h6>
                            <div>
                                <button class="btn btn-sm btn-outline-info me-2" onclick="event.stopPropagation(); showFileStats('${file.name}')" title="Статистика">
                                    <i class="fas fa-chart-bar"></i>
                                </button>
                                <small>${formatFileSize(file.size)}</small>
                            </div>
                        </div>
                        <p class="mb-1">Модифіковано: ${new Date(file.modified).toLocaleString('uk-UA')}</p>
                    `;
                    
                    fileItem.addEventListener('click', () => loadFileContent(file.name));
                    filesList.appendChild(fileItem);
                });
                } else {
                    console.log('Немає файлів для відображення');
                    filesList.innerHTML = '<div class="list-group-item text-muted">Файли не знайдені</div>';
                }
                console.log('Завантаження файлів завершено');
            } catch (error) {
                console.error('Помилка завантаження списку файлів:', error);
                showError('Помилка завантаження списку файлів: ' + error.message);
                document.getElementById('files-list').innerHTML = '<div class="list-group-item text-danger">Помилка завантаження файлів</div>';
            }
        }

        async function loadFileContent(filename, offset = 0) {
            try {
                currentFile = filename;
                currentOffset = offset;
                
                const response = await fetch(`/api/files/${filename}?limit=${pageSize}&offset=${offset}`);
                const result = await response.json();
                
                displayFileContent(result);
                updatePagination(result);
            } catch (error) {
                console.error('Помилка завантаження вмісту файлу:', error);
                showError('Помилка завантаження вмісту файлу: ' + error.message);
            }
        }

        function displayFileContent(fileData) {
            const contentDiv = document.getElementById('file-content');
            
            if (!fileData.data || fileData.data.length === 0) {
                contentDiv.innerHTML = '<p class="text-muted">Файл порожній</p>';
                return;
            }
            
            // Створюємо таблицю
            let tableHtml = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                ${fileData.columns.map(col => `<th>${col}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            fileData.data.forEach(row => {
                tableHtml += '<tr>';
                fileData.columns.forEach(col => {
                    const value = row[col];
                    const displayValue = value === null || value === undefined ? '-' : value;
                    tableHtml += `<td>${displayValue}</td>`;
                });
                tableHtml += '</tr>';
            });
            
            tableHtml += `
                        </tbody>
                    </table>
                </div>
                <div class="mt-2">
                    <small class="text-muted">
                        Показано ${fileData.offset + 1}-${fileData.offset + fileData.data.length} з ${fileData.total_rows} записів
                    </small>
                </div>
            `;
            
            contentDiv.innerHTML = tableHtml;
        }

        function updatePagination(fileData) {
            const paginationDiv = document.getElementById('file-pagination');
            const totalPages = Math.ceil(fileData.total_rows / pageSize);
            const currentPage = Math.floor(fileData.offset / pageSize) + 1;
            
            if (totalPages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }
            
            let paginationHtml = '<nav><ul class="pagination pagination-sm">';
            
            // Кнопка "Попередня"
            if (currentPage > 1) {
                paginationHtml += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="loadFileContent('${currentFile}', ${(currentPage - 2) * pageSize})">Попередня</a>
                    </li>
                `;
            }
            
            // Номери сторінок
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentPage ? 'active' : '';
                paginationHtml += `
                    <li class="page-item ${isActive}">
                        <a class="page-link" href="#" onclick="loadFileContent('${currentFile}', ${(i - 1) * pageSize})">${i}</a>
                    </li>
                `;
            }
            
            // Кнопка "Наступна"
            if (currentPage < totalPages) {
                paginationHtml += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="loadFileContent('${currentFile}', ${currentPage * pageSize})">Наступна</a>
                    </li>
                `;
            }
            
            paginationHtml += '</ul></nav>';
            paginationDiv.innerHTML = paginationHtml;
        }

        async function showFileStats(filename) {
            try {
                const response = await fetch(`/api/files/${filename}/stats`);
                const stats = await response.json();
                
                let statsHtml = `
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Статистика файлу: ${stats.filename}</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Рядків:</strong> ${stats.total_rows.toLocaleString()}</p>
                                    <p><strong>Колонок:</strong> ${stats.total_columns}</p>
                                    <p><strong>Розмір в пам'яті:</strong> ${formatFileSize(stats.memory_usage)}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Колонки:</strong></p>
                                    <ul class="list-unstyled">
                                        ${stats.columns.map(col => `<li><code>${col}</code> (${stats.data_types[col]})</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                `;
                
                if (stats.numeric_stats) {
                    statsHtml += `
                        <div class="mt-3">
                            <h6>Статистика числових колонок:</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Колонка</th>
                                            <th>Мін</th>
                                            <th>Макс</th>
                                            <th>Середнє</th>
                                            <th>Медіана</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    Object.keys(stats.numeric_stats).forEach(col => {
                        const colStats = stats.numeric_stats[col];
                        statsHtml += `
                            <tr>
                                <td><code>${col}</code></td>
                                <td>${colStats.min?.toFixed(2) || '-'}</td>
                                <td>${colStats.max?.toFixed(2) || '-'}</td>
                                <td>${colStats.mean?.toFixed(2) || '-'}</td>
                                <td>${colStats['50%']?.toFixed(2) || '-'}</td>
                            </tr>
                        `;
                    });
                    
                    statsHtml += '</tbody></table></div>';
                }
                
                statsHtml += '</div></div>';
                
                // Показуємо статистику в модальному вікні
                const modalHtml = `
                    <div class="modal fade" id="statsModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Статистика файлу</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    ${statsHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Видаляємо попередній модаль, якщо існує
                const existingModal = document.getElementById('statsModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Додаємо новий модаль
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Показуємо модаль
                const modal = new bootstrap.Modal(document.getElementById('statsModal'));
                modal.show();
                
            } catch (error) {
                console.error('Помилка завантаження статистики файлу:', error);
                showError('Помилка завантаження статистики файлу: ' + error.message);
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Функції для роботи з даними Світового банку
        let worldBankData = null;
        let availableCountries = {};
        let availableIndicators = {};

        // Ініціалізація даних Світового банку
        async function initializeWorldBankData() {
            try {
                // Завантажуємо списки країн та показників
                const [countriesResponse, indicatorsResponse] = await Promise.all([
                    fetch('/api/worldbank/countries'),
                    fetch('/api/worldbank/indicators-list')
                ]);

                const countriesData = await countriesResponse.json();
                const indicatorsData = await indicatorsResponse.json();

                availableCountries = countriesData.countries;
                availableIndicators = indicatorsData.indicators;

                // Заповнюємо селекти
                populateWorldBankSelects();

            } catch (error) {
                console.error('Помилка ініціалізації даних Світового банку:', error);
                showError('Помилка завантаження списків країн та показників');
            }
        }

        function populateWorldBankSelects() {
            // Заповнюємо селект країн
            const countriesSelect = document.getElementById('worldbank-countries');
            countriesSelect.innerHTML = '';
            
            Object.entries(availableCountries).forEach(([code, name]) => {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${name} (${code})`;
                countriesSelect.appendChild(option);
            });

            // Заповнюємо селект показників
            const indicatorsSelect = document.getElementById('worldbank-indicators');
            indicatorsSelect.innerHTML = '';
            
            Object.entries(availableIndicators).forEach(([key, code]) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = key.replace(/_/g, ' ');
                indicatorsSelect.appendChild(option);
            });
        }

        async function loadWorldBankData() {
            try {
                const countries = Array.from(document.getElementById('worldbank-countries').selectedOptions)
                    .map(option => option.value);
                const indicators = Array.from(document.getElementById('worldbank-indicators').selectedOptions)
                    .map(option => option.value);
                const startYear = document.getElementById('worldbank-start-year').value;
                const endYear = document.getElementById('worldbank-end-year').value;

                const params = new URLSearchParams();
                if (countries.length > 0) params.append('countries', countries.join(','));
                if (indicators.length > 0) params.append('indicators', indicators.join(','));
                params.append('start_year', startYear);
                params.append('end_year', endYear);

                const response = await fetch(`/api/worldbank/indicators?${params}`);
                const result = await response.json();

                worldBankData = result;
                updateWorldBankIndicatorsChart(result);
                updateWorldBankIndicatorsTable(result);

            } catch (error) {
                console.error('Помилка завантаження даних Світового банку:', error);
                showError('Помилка завантаження даних Світового банку: ' + error.message);
            }
        }

        function updateWorldBankIndicatorsChart(data) {
            if (!data.data || data.data.length === 0) {
                document.getElementById('worldbank-indicators-chart').innerHTML = '<p class="text-muted">Немає даних для відображення</p>';
                return;
            }

            // Групуємо дані за країнами та роками
            const chartData = {};
            data.data.forEach(row => {
                const country = row.Country_Name;
                const year = row.Year;
                
                if (!chartData[country]) {
                    chartData[country] = {};
                }
                chartData[country][year] = row;
            });

            // Створюємо графік
            const traces = [];
            Object.entries(chartData).forEach(([country, years]) => {
                const sortedYears = Object.keys(years).sort();
                const gdpData = sortedYears.map(year => years[year].GDP || 0);
                
                traces.push({
                    x: sortedYears,
                    y: gdpData,
                    name: country,
                    type: 'scatter',
                    mode: 'lines+markers'
                });
            });

            const layout = {
                title: 'ВВП країн у часі',
                xaxis: { title: 'Рік' },
                yaxis: { title: 'ВВП (долари США)' },
                hovermode: 'closest'
            };

            Plotly.newPlot('worldbank-indicators-chart', traces, layout);
        }

        function updateWorldBankIndicatorsTable(data) {
            const tbody = document.querySelector('#worldbank-indicators-table tbody');
            tbody.innerHTML = '';

            if (!data.data || data.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-muted">Немає даних для відображення</td></tr>';
                return;
            }

            data.data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.Country_Name}</td>
                    <td>${row.Year}</td>
                    <td>${row.GDP ? row.GDP.toLocaleString() : '-'}</td>
                    <td>${row.GDP_PER_CAPITA ? row.GDP_PER_CAPITA.toLocaleString() : '-'}</td>
                    <td>${row.INFLATION ? row.INFLATION.toFixed(2) + '%' : '-'}</td>
                    <td>${row.UNEMPLOYMENT ? row.UNEMPLOYMENT.toFixed(2) + '%' : '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function loadComparisonData() {
            try {
                const countries = document.getElementById('comparison-countries').value;
                const indicator = document.getElementById('comparison-indicator').value;
                const years = document.getElementById('comparison-years').value;

                const params = new URLSearchParams();
                params.append('countries', countries);
                params.append('indicator', indicator);
                params.append('years', years);

                const response = await fetch(`/api/worldbank/comparison?${params}`);
                const result = await response.json();

                updateComparisonChart(result);

            } catch (error) {
                console.error('Помилка завантаження даних порівняння:', error);
                showError('Помилка завантаження даних порівняння: ' + error.message);
            }
        }

        function updateComparisonChart(data) {
            if (!data.data || data.data.length === 0) {
                document.getElementById('worldbank-comparison-chart').innerHTML = '<p class="text-muted">Немає даних для відображення</p>';
                return;
            }

            // Групуємо дані за країнами
            const chartData = {};
            data.data.forEach(row => {
                const country = row.Country_Name;
                if (!chartData[country]) {
                    chartData[country] = [];
                }
                chartData[country].push({
                    year: row.Year,
                    value: row.Value
                });
            });

            // Створюємо графік
            const traces = [];
            Object.entries(chartData).forEach(([country, values]) => {
                const sortedValues = values.sort((a, b) => a.year - b.year);
                
                traces.push({
                    x: sortedValues.map(v => v.year),
                    y: sortedValues.map(v => v.value),
                    name: country,
                    type: 'scatter',
                    mode: 'lines+markers'
                });
            });

            const layout = {
                title: `Порівняння країн: ${data.indicator}`,
                xaxis: { title: 'Рік' },
                yaxis: { title: 'Значення' },
                hovermode: 'closest'
            };

            Plotly.newPlot('worldbank-comparison-chart', traces, layout);
        }

        async function loadTrendsData() {
            try {
                const country = document.getElementById('trends-country').value;
                const indicators = Array.from(document.getElementById('trends-indicators').selectedOptions)
                    .map(option => option.value);
                const years = document.getElementById('trends-years').value;

                const params = new URLSearchParams();
                if (indicators.length > 0) params.append('indicators', indicators.join(','));
                params.append('years', years);

                const response = await fetch(`/api/worldbank/trends/${country}?${params}`);
                const result = await response.json();

                updateTrendsChart(result);
                updateTrendsAnalysis(result);

            } catch (error) {
                console.error('Помилка завантаження даних трендів:', error);
                showError('Помилка завантаження даних трендів: ' + error.message);
            }
        }

        function updateTrendsChart(data) {
            if (!data.raw_data || data.raw_data.length === 0) {
                document.getElementById('worldbank-trends-chart').innerHTML = '<p class="text-muted">Немає даних для відображення</p>';
                return;
            }

            // Створюємо графік з кількома показниками
            const traces = [];
            const indicators = Object.keys(data.trends || {});
            
            indicators.forEach(indicator => {
                const values = data.raw_data
                    .filter(row => row[indicator] !== null && row[indicator] !== undefined)
                    .sort((a, b) => a.Year - b.Year);
                
                if (values.length > 0) {
                    traces.push({
                        x: values.map(v => v.Year),
                        y: values.map(v => v[indicator]),
                        name: indicator.replace(/_/g, ' '),
                        type: 'scatter',
                        mode: 'lines+markers',
                        yaxis: 'y' + (traces.length > 0 ? traces.length + 1 : '')
                    });
                }
            });

            const layout = {
                title: `Тренди для ${data.country}`,
                xaxis: { title: 'Рік' },
                hovermode: 'closest'
            };

            // Додаємо осі для кожного показника
            indicators.forEach((indicator, index) => {
                if (index > 0) {
                    layout[`yaxis${index + 1}`] = {
                        title: indicator.replace(/_/g, ' '),
                        overlaying: 'y',
                        side: 'right'
                    };
                } else {
                    layout.yaxis = {
                        title: indicator.replace(/_/g, ' ')
                    };
                }
            });

            Plotly.newPlot('worldbank-trends-chart', traces, layout);
        }

        function updateTrendsAnalysis(data) {
            const analysisDiv = document.getElementById('trends-analysis');
            
            if (!data.trends || Object.keys(data.trends).length === 0) {
                analysisDiv.innerHTML = '<p class="text-muted">Немає даних для аналізу</p>';
                return;
            }

            let analysisHtml = `
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Аналіз трендів для ${data.country}</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
            `;

            Object.entries(data.trends).forEach(([indicator, trend]) => {
                const directionClass = trend.direction === 'зростання' ? 'text-success' : 'text-danger';
                const directionIcon = trend.direction === 'зростання' ? 'fa-arrow-up' : 'fa-arrow-down';
                
                analysisHtml += `
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">${indicator.replace(/_/g, ' ')}</h6>
                                <p class="card-text">
                                    <i class="fas ${directionIcon} ${directionClass} me-1"></i>
                                    <strong>Тренд:</strong> <span class="${directionClass}">${trend.direction}</span><br>
                                    <strong>Останнє значення:</strong> ${trend.latest_value?.toLocaleString() || 'N/A'}<br>
                                    <strong>Років проаналізовано:</strong> ${trend.years_analyzed}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            });

            analysisHtml += `
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                Період аналізу: ${data.analysis_period}
                            </small>
                        </div>
                    </div>
                </div>
            `;

            analysisDiv.innerHTML = analysisHtml;
        }
        
        // Функція для завантаження нормалізованих даних
        async function loadNormalizedData() {
            console.log('Запуск loadNormalizedData...');
            const countries = Array.from(document.getElementById('normalized-countries').selectedOptions).map(option => option.value);
            const indicators = Array.from(document.getElementById('normalized-indicators').selectedOptions).map(option => option.value);
            const currency = document.getElementById('normalized-currency').value;
            const startYear = document.getElementById('normalized-start-year').value;
            const endYear = document.getElementById('normalized-end-year').value;
            
            console.log('Параметри:', { countries, indicators, currency, startYear, endYear });
            
            if (countries.length === 0 || indicators.length === 0) {
                showError('Будь ласка, оберіть країни та показники');
                return;
            }
            
            try {
                showLoading();
                
                const params = new URLSearchParams({
                    countries: countries.join(','),
                    indicators: indicators.join(','),
                    start_year: startYear,
                    end_year: endYear,
                    currency: currency
                });
                
                const response = await fetch(`/api/worldbank/normalized?${params}`);
                const result = await response.json();
                
                if (response.ok) {
                    console.log('Отримані дані:', result);
                    updateNormalizedChart(result.data, result.normalization_info, currency);
                    updateNormalizedTable(result.data, result.normalization_info);
                } else {
                    console.error('Помилка відповіді:', result);
                    showError(result.detail || 'Помилка завантаження нормалізованих даних');
                }
            } catch (error) {
                showError('Помилка завантаження нормалізованих даних: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Функція для оновлення графіка нормалізованих даних
        function updateNormalizedChart(data, normalizationInfo, currency) {
            console.log('updateNormalizedChart викликано з:', { data, normalizationInfo, currency });
            
            if (!data || data.length === 0) {
                console.log('Дані порожні, показуємо порожній графік');
                Plotly.newPlot('normalized-chart', [], {}, {responsive: true});
                return;
            }
            
            const traces = [];
            const countries = [...new Set(data.map(item => item.Country_Name))];
            const indicators = Object.keys(normalizationInfo);
            
            console.log('Країни:', countries);
            console.log('Показники:', indicators);
            
            indicators.forEach(indicator => {
                if (indicator === 'Country' || indicator === 'Country_Name' || indicator === 'Year') return;
                
                const trace = {
                    x: countries,
                    y: countries.map(country => {
                        const countryData = data.find(item => item.Country_Name === country);
                        return countryData ? countryData[indicator] : null;
                    }),
                    type: 'bar',
                    name: getIndicatorName(indicator),
                    text: countries.map(country => {
                        const countryData = data.find(item => item.Country_Name === country);
                        return countryData ? `${countryData[indicator]} ${normalizationInfo[indicator]}` : '';
                    }),
                    textposition: 'auto'
                };
                
                traces.push(trace);
            });
            
            console.log('Створені traces:', traces);
            
            const layout = {
                title: `Нормалізовані економічні показники (${currency})`,
                xaxis: { title: 'Країни' },
                yaxis: { title: 'Значення' },
                barmode: 'group',
                responsive: true
            };
            
            Plotly.newPlot('normalized-chart', traces, layout, {responsive: true});
        }
        
        // Функція для оновлення таблиці нормалізованих даних
        function updateNormalizedTable(data, normalizationInfo) {
            const tableDiv = document.getElementById('normalized-table');
            
            if (!data || data.length === 0) {
                tableDiv.innerHTML = '<div class="alert alert-warning">Немає даних для відображення</div>';
                return;
            }
            
            let html = '<div class="card"><div class="card-header"><h6 class="mb-0">Нормалізовані дані</h6></div><div class="card-body"><div class="table-responsive"><table class="table table-striped"><thead><tr>';
            
            // Заголовки таблиці
            html += '<th>Країна</th><th>Рік</th>';
            Object.keys(normalizationInfo).forEach(indicator => {
                html += `<th>${getIndicatorName(indicator)} (${normalizationInfo[indicator]})</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // Дані таблиці
            data.forEach(row => {
                html += `<tr><td>${row.Country_Name}</td><td>${row.Year}</td>`;
                Object.keys(normalizationInfo).forEach(indicator => {
                    const value = row[indicator] !== null ? row[indicator].toFixed(2) : 'N/A';
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div></div></div>';
            tableDiv.innerHTML = html;
        }
        
        // Функція для завантаження аналізу економічного здоров'я
        async function loadEconomicHealth() {
            const countries = Array.from(document.getElementById('health-countries').selectedOptions).map(option => option.value);
            const startYear = document.getElementById('health-start-year').value;
            const endYear = document.getElementById('health-end-year').value;
            
            if (countries.length === 0) {
                showError('Будь ласка, оберіть країни для аналізу');
                return;
            }
            
            try {
                showLoading();
                
                const params = new URLSearchParams({
                    countries: countries.join(','),
                    start_year: startYear,
                    end_year: endYear
                });
                
                const response = await fetch(`/api/worldbank/economic-health?${params}`);
                const result = await response.json();
                
                if (response.ok) {
                    updateHealthChart(result.analysis);
                    updateHealthAnalysis(result.analysis, result.methodology);
                } else {
                    showError(result.detail || "Помилка аналізу економічного здоров'я");
                }
            } catch (error) {
                showError("Помилка аналізу економічного здоров'я: " + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Функція для оновлення графіка економічного здоров'я
        function updateHealthChart(analysis) {
            if (!analysis || Object.keys(analysis).length === 0) {
                Plotly.newPlot('health-chart', [], {}, {responsive: true});
                return;
            }
            
            const countries = Object.keys(analysis).map(code => analysis[code].country_name);
            const scores = Object.keys(analysis).map(code => analysis[code].health_score);
            const levels = Object.keys(analysis).map(code => analysis[code].health_level);
            
            // Кольори залежно від рівня здоров'я
            const colors = levels.map(level => {
                switch(level) {
                    case 'Відмінний': return '#28a745';
                    case 'Добрий': return '#17a2b8';
                    case 'Середній': return '#ffc107';
                    case 'Поганий': return '#fd7e14';
                    case 'Критичний': return '#dc3545';
                    default: return '#6c757d';
                }
            });
            
            const trace = {
                x: countries,
                y: scores,
                type: 'bar',
                marker: { color: colors },
                text: levels,
                textposition: 'auto'
            };
            
            const layout = {
                title: "Індекс економічного здоров'я країн",
                xaxis: { title: 'Країни' },
                yaxis: { title: 'Бал (0-100)', range: [0, 100] },
                responsive: true
            };
            
            Plotly.newPlot('health-chart', [trace], layout, {responsive: true});
        }
        
        // Функція для оновлення аналізу економічного здоров'я
        function updateHealthAnalysis(analysis, methodology) {
            const analysisDiv = document.getElementById('health-analysis');
            
            if (!analysis || Object.keys(analysis).length === 0) {
                analysisDiv.innerHTML = '<div class="alert alert-warning">Немає даних для аналізу</div>';
                return;
            }
            
            let html = '<div class="row">';
            
            // Сортуємо країни за балом
            const sortedCountries = Object.keys(analysis).sort((a, b) => analysis[b].health_score - analysis[a].health_score);
            
            sortedCountries.forEach(countryCode => {
                const country = analysis[countryCode];
                const levelClass = getHealthLevelClass(country.health_level);
                
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">${country.country_name}</h6>
                                <span class="badge ${levelClass}">${country.health_level}</span>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <strong>Загальний бал:</strong> ${country.health_score}/100
                                </div>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar ${levelClass.replace('bg-', 'bg-')}" 
                                         style="width: ${country.health_score}%">
                                        ${country.health_score}%
                                    </div>
                                </div>
                                <div class="small">
                `;
                
                // Показники
                Object.entries(country.indicators).forEach(([indicator, data]) => {
                    html += `
                        <div class="d-flex justify-content-between">
                            <span>${getIndicatorName(indicator)}:</span>
                            <span>${data.value.toFixed(2)} (${data.score}/100)</span>
                        </div>
                    `;
                });
                
                html += `
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Додаємо методологію
            html += `
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">Методологія оцінки</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
            `;
            
            Object.entries(methodology).forEach(([indicator, description]) => {
                html += `
                    <div class="col-md-6 mb-2">
                        <strong>${getIndicatorName(indicator)}:</strong> ${description}
                    </div>
                `;
            });
            
            html += '</div></div></div>';
            
            analysisDiv.innerHTML = html;
        }
        
        // Допоміжна функція для отримання класу CSS для рівня здоров'я
        function getHealthLevelClass(level) {
            switch(level) {
                case 'Excellent': return 'bg-success';
                case 'Good': return 'bg-info';
                case 'Medium': return 'bg-warning';
                case 'Poor': return 'bg-danger';
                case 'Critical': return 'bg-dark';
                case 'No Data': return 'bg-secondary';
                default: return 'bg-secondary';
            }
        }
    </script>
</body>
</html>
